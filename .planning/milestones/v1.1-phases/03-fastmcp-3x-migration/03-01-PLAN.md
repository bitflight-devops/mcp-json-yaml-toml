---
phase: 03-fastmcp-3x-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - packages/mcp_json_yaml_toml/server.py
  - packages/mcp_json_yaml_toml/tests/test_fastmcp_integration.py
autonomous: true

must_haves:
  truths:
    - "pyproject.toml pins fastmcp>=3.0.0rc1 and uv sync succeeds"
    - "All 393+ existing tests pass on FastMCP 3.x without modification to tool logic"
    - "FastMCP Client integration tests pass with 3.x client API"
    - "Synchronous tool functions dispatch to automatic threadpool (no manual executor code exists)"
  artifacts:
    - path: "pyproject.toml"
      provides: "FastMCP 3.x dependency pin"
      contains: "fastmcp>=3.0.0rc1"
    - path: "packages/mcp_json_yaml_toml/server.py"
      provides: "FastMCP 3.x compatible server initialization"
      contains: "from fastmcp import FastMCP"
  key_links:
    - from: "pyproject.toml"
      to: "uv.lock"
      via: "uv dependency resolution"
      pattern: "fastmcp.*3\\.0"
    - from: "packages/mcp_json_yaml_toml/server.py"
      to: "packages/mcp_json_yaml_toml/tools/*.py"
      via: "@mcp.tool decorator registration"
      pattern: "from mcp_json_yaml_toml.server import mcp"
---

<objective>
Migrate from FastMCP 2.x to FastMCP 3.x with all existing tests passing.

Purpose: FastMCP 3.x unlocks automatic threadpool dispatch for synchronous tools, native tool timeouts, and outputSchema auto-generation from Pydantic models. This plan handles the core dependency upgrade and import compatibility -- the highest-risk step that must succeed before any 3.x features can be adopted.

Output: Working server on FastMCP 3.x with all 393+ tests green. FMCP-01 and FMCP-02 satisfied (automatic threadpool is implicit for sync tools on 3.x).
</objective>

<execution_context>
@/home/ubuntulinuxqa2/.claude/get-shit-done/workflows/execute-plan.md
@/home/ubuntulinuxqa2/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-fastmcp-3x-migration/03-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Upgrade FastMCP dependency to 3.x and resolve import compatibility</name>
  <files>pyproject.toml, packages/mcp_json_yaml_toml/server.py</files>
  <action>
1. Update pyproject.toml dependency from `fastmcp>=2.14.4,<3` to `fastmcp>=3.0.0rc1,<4`.
   - Update the comment alongside the dependency to reflect the migration: remove the "Pin to v2 until v3 is stable" comment and replace with "# FastMCP 3.x - automatic threadpool, tool timeouts, outputSchema".
   - Note: 3.0.0rc2 is the latest pre-release. Using `>=3.0.0rc1` as the lower bound allows uv to resolve pre-release versions. If uv refuses to resolve a pre-release, use `--prerelease=allow` flag or set `[tool.uv]` config in pyproject.toml with `prerelease = "allow"` for the fastmcp package.

2. Run `uv sync` to install FastMCP 3.x and update the lockfile.

3. Verify import compatibility for all fastmcp imports in the codebase:
   - `from fastmcp import FastMCP` (server.py) -- already correct for 3.x
   - `from fastmcp.exceptions import ToolError` (8+ files) -- verify this import path exists in 3.x
   - `from fastmcp import Client` (test_fastmcp_integration.py) -- verify this import path exists in 3.x
   - `from fastmcp.client.client import CallToolResult` (test_fastmcp_integration.py) -- verify this import path exists in 3.x; if moved, update the TYPE_CHECKING import
   - `from mcp.types import TextContent` (test_fastmcp_integration.py) -- this imports from the `mcp` package (not fastmcp), verify it still works with the `mcp` version pulled by FastMCP 3.x

4. If any import paths have changed in FastMCP 3.x, update them across all affected files. Use grep to find all occurrences before making changes.

5. Check if FastMCP 3.x changed decorator behavior:
   - The `annotations` parameter on `@mcp.tool()` -- verify it still works
   - The `@mcp.resource()` and `@mcp.prompt()` decorators in tools/constraints.py -- verify they still work
   - Pydantic return type annotation on tools -- verify outputSchema generation doesn't break existing behavior

6. If `mask_error_details=False` parameter on `FastMCP()` constructor has been renamed or removed in 3.x, update server.py accordingly.

Do NOT add any manual ThreadPoolExecutor code. FastMCP 3.x dispatches synchronous tool functions to a threadpool automatically -- this is FMCP-02 satisfied with zero code changes.
</action>
<verify>
Run: `uv sync && uv run python -c "import fastmcp; print(fastmcp.__version__)"` -- should print 3.0.0rc2 or later.
Run: `uv run python -c "from fastmcp import FastMCP; from fastmcp.exceptions import ToolError; from fastmcp import Client; print('All imports OK')"` -- should succeed.
Run: `uv run python -c "from mcp_json_yaml_toml.server import mcp; print(type(mcp))"` -- should show FastMCP instance.
</verify>
<done>pyproject.toml pins fastmcp>=3.0.0rc1,<4, uv sync resolves successfully, all FastMCP imports work.</done>
</task>

<task type="auto">
  <name>Task 2: Run full test suite and fix any FastMCP 3.x compatibility issues</name>
  <files>packages/mcp_json_yaml_toml/tests/test_fastmcp_integration.py</files>
  <action>
1. Run the full test suite: `uv run pytest`
   - All 393+ tests should pass. If failures occur, diagnose each one.

2. Common FastMCP 3.x test breakages to check for:
   - `CallToolResult` import path may have changed -- if so, update TYPE_CHECKING import in test_fastmcp_integration.py
   - `Client` constructor API may have changed -- if `Client(mcp)` no longer works, check FastMCP 3.x Client API
   - `TextContent` may have moved from `mcp.types` to another location in the new mcp SDK version
   - Decorated tool functions may return component objects instead of being callable in 3.x if FASTMCP_DECORATOR_MODE is set -- ensure it is NOT set
   - `result.content[0]` access pattern on CallToolResult may have changed

3. If test_fastmcp_integration.py tests fail:
   - Check if the Client async context manager API changed
   - Check if call_tool return type changed
   - Check if error handling/propagation changed (test_error_handling_missing_file)
   - Update test code to match 3.x API while preserving the same behavioral assertions

4. If any tool registration tests fail (e.g., tools not being registered):
   - Verify that `@mcp.tool` decorator in tools/\*.py still registers correctly
   - Check if `@mcp.resource` and `@mcp.prompt` decorators in tools/constraints.py still work

5. Run linting after any test file changes: `uv run prek run --files <changed_files>`

6. Do NOT modify any tool implementation logic. This task is purely about compatibility -- if a test fails because of a behavioral change in FastMCP 3.x (not an API change), document it and investigate before changing.
   </action>
   <verify>
   Run: `uv run pytest` -- all tests pass (393+ tests, 0 failures).
   Run: `uv run pytest packages/mcp_json_yaml_toml/tests/test_fastmcp_integration.py -v` -- all integration tests pass specifically.
   Run: `uv run prek run --files pyproject.toml packages/mcp_json_yaml_toml/server.py packages/mcp_json_yaml_toml/tests/test_fastmcp_integration.py` -- all linting gates pass.
   </verify>
   <done>All 393+ tests pass on FastMCP 3.x. No manual threadpool code exists (FMCP-02 satisfied by framework). Linting clean.</done>
   </task>

</tasks>

<verification>
1. `uv run python -c "import fastmcp; print(fastmcp.__version__)"` prints 3.0.0rc2+
2. `uv run pytest` -- all tests pass
3. `uv run pytest packages/mcp_json_yaml_toml/tests/test_fastmcp_integration.py -v` -- integration tests pass
4. `grep -r "ThreadPoolExecutor" packages/` returns no results (no manual executor)
5. `grep "fastmcp" pyproject.toml` shows `fastmcp>=3.0.0rc1,<4`
</verification>

<success_criteria>

- pyproject.toml pins fastmcp>=3.0.0rc1,<4 and uv resolves it
- All 393+ existing tests pass unchanged (or with minimal API-level fixes in test code)
- No manual ThreadPoolExecutor code exists anywhere in the codebase
- FastMCP Client integration tests work with 3.x Client API
- FMCP-01 (migration) and FMCP-02 (automatic threadpool) requirements satisfied
  </success_criteria>

<output>
After completion, create `.planning/phases/03-fastmcp-3x-migration/03-01-SUMMARY.md`
</output>
