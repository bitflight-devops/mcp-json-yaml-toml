---
phase: 03-fastmcp-3x-migration
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - packages/mcp_json_yaml_toml/tools/data.py
  - packages/mcp_json_yaml_toml/tools/query.py
  - packages/mcp_json_yaml_toml/tools/schema.py
  - packages/mcp_json_yaml_toml/tools/convert.py
  - packages/mcp_json_yaml_toml/tools/constraints.py
  - packages/mcp_json_yaml_toml/services/schema_validation.py
autonomous: true

must_haves:
  truths:
    - "All 7 tools have timeout parameters set on @mcp.tool decorators"
    - "JSON Schema validation defaults to Draft 2020-12 when no $schema field is present"
    - "Schemas with explicit $schema draft-07 still use Draft 7 validator"
    - "All Pydantic-returning tools auto-generate outputSchema in tool listing"
    - "All tests pass after timeout and schema default changes"
  artifacts:
    - path: "packages/mcp_json_yaml_toml/tools/data.py"
      provides: "data tool with timeout parameter"
      contains: "timeout="
    - path: "packages/mcp_json_yaml_toml/tools/query.py"
      provides: "data_query tool with timeout parameter"
      contains: "timeout="
    - path: "packages/mcp_json_yaml_toml/tools/convert.py"
      provides: "data_convert and data_merge tools with timeout parameters"
      contains: "timeout="
    - path: "packages/mcp_json_yaml_toml/tools/schema.py"
      provides: "data_schema tool with timeout parameter"
      contains: "timeout="
    - path: "packages/mcp_json_yaml_toml/tools/constraints.py"
      provides: "constraint_validate and constraint_list tools with timeout parameters"
      contains: "timeout="
    - path: "packages/mcp_json_yaml_toml/services/schema_validation.py"
      provides: "Draft 2020-12 as default validator"
      contains: "Draft202012Validator"
  key_links:
    - from: "packages/mcp_json_yaml_toml/tools/data.py"
      to: "packages/mcp_json_yaml_toml/services/data_operations.py"
      via: "tool -> service dispatch"
      pattern: "_dispatch_.*_operation"
    - from: "packages/mcp_json_yaml_toml/services/schema_validation.py"
      to: "packages/mcp_json_yaml_toml/tools/schema.py"
      via: "schema validation service"
      pattern: "_validate_against_schema"
---

<objective>
Add tool timeout protection and upgrade JSON Schema default validator to Draft 2020-12.

Purpose: Timeout parameters prevent long-running yq operations from hanging indefinitely (FMCP-03). Upgrading the JSON Schema default from Draft 7 to Draft 2020-12 aligns with the current standard (SAFE-02). This plan also verifies that Pydantic-returning tools auto-generate outputSchema on FastMCP 3.x (success criteria #4).

Output: All 7 tools have timeout protection, schema validation defaults to Draft 2020-12, and outputSchema auto-generation verified. FMCP-03 and SAFE-02 requirements satisfied.
</objective>

<execution_context>
@/home/ubuntulinuxqa2/.claude/get-shit-done/workflows/execute-plan.md
@/home/ubuntulinuxqa2/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-fastmcp-3x-migration/03-RESEARCH.md
@.planning/phases/03-fastmcp-3x-migration/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add timeout parameters to all tool decorators</name>
  <files>
packages/mcp_json_yaml_toml/tools/data.py
packages/mcp_json_yaml_toml/tools/query.py
packages/mcp_json_yaml_toml/tools/schema.py
packages/mcp_json_yaml_toml/tools/convert.py
packages/mcp_json_yaml_toml/tools/constraints.py
  </files>
  <action>
Add `timeout` parameter to every `@mcp.tool()` decorator. FastMCP 3.x supports `timeout=<seconds>` to limit foreground execution time; exceeding the timeout raises MCP error code -32000.

Timeout values (conservative, based on operation characteristics):

1. **data** tool (`tools/data.py`): `timeout=60.0`
   - Performs file I/O + yq subprocess for get/set/delete operations
   - Set/delete includes file write -- allow generous time for large files
   - Add to existing `@mcp.tool(annotations={...})` as: `@mcp.tool(timeout=60.0, annotations={...})`

2. **data_query** tool (`tools/query.py`): `timeout=60.0`
   - Read-only yq query with possible TOML fallback retry
   - Large files with complex expressions may take time

3. **data_schema** tool (`tools/schema.py`): `timeout=60.0`
   - Validate action involves yq parse + HTTP schema fetch (httpx with 10s timeout) + validation
   - Scan action recursively walks directories
   - 60s accounts for slow network + large schemas

4. **data_convert** tool (`tools/convert.py`): `timeout=60.0`
   - yq format conversion + possible file write
   - Same timeout as other file-processing tools

5. **data_merge** tool (`tools/convert.py`): `timeout=60.0`
   - Reads two files + merge expression + possible file write
   - Same generous timeout

6. **constraint_validate** tool (`tools/constraints.py`): `timeout=10.0`
   - Pure in-memory regex validation -- no I/O
   - 10 seconds is generous for regex matching

7. **constraint_list** tool (`tools/constraints.py`): `timeout=10.0`
   - Pure in-memory registry access -- no I/O
   - 10 seconds is generous

For each tool, add `timeout=` to the existing `@mcp.tool()` call. The `annotations` dict remains unchanged.

Example transformation:

```python
# Before
@mcp.tool(
    annotations={
        "readOnlyHint": True,
        ...
    }
)

# After
@mcp.tool(
    timeout=60.0,
    annotations={
        "readOnlyHint": True,
        ...
    }
)
```

Verify that the `timeout` parameter is accepted by FastMCP 3.x's `@mcp.tool` decorator. If the parameter name is different (e.g., `timeout_seconds`), use the correct name from the FastMCP 3.x API.
</action>
<verify>
Run: `uv run python -c "from mcp_json_yaml_toml.server import mcp; print('Server loaded with timeouts')"` -- should succeed without errors.
Run: `uv run pytest packages/mcp_json_yaml_toml/tests/test_server.py -v` -- server tests pass.
Run: `uv run pytest packages/mcp_json_yaml_toml/tests/test_fastmcp_integration.py -v` -- integration tests pass.
</verify>
<done>All 7 tools have timeout parameters. File-processing tools at 60s, in-memory tools at 10s.</done>
</task>

<task type="auto">
  <name>Task 2: Upgrade JSON Schema default validator to Draft 2020-12 and verify outputSchema</name>
  <files>packages/mcp_json_yaml_toml/services/schema_validation.py</files>
  <action>
**Part A: Upgrade JSON Schema default validator (SAFE-02)**

In `services/schema_validation.py`, change the default validator from Draft 7 to Draft 2020-12.

Current logic (lines 70-76):

```python
schema_dialect = schema.get("$schema", "")
if "draft/2020-12" in schema_dialect or "draft-2020-12" in schema_dialect:
    Draft202012Validator(schema, registry=registry).validate(data)
else:
    # Default to Draft 7 which is most common
    Draft7Validator(schema, registry=registry).validate(data)
```

New logic:

```python
schema_dialect = schema.get("$schema", "")
if "draft-07" in schema_dialect or "draft/7" in schema_dialect:
    Draft7Validator(schema, registry=registry).validate(data)
else:
    # Default to Draft 2020-12 (current JSON Schema standard)
    Draft202012Validator(schema, registry=registry).validate(data)
```

This inverts the default: schemas without a `$schema` field now validate with Draft 2020-12. Schemas with explicit Draft 7 `$schema` (`http://json-schema.org/draft-07/schema#`) still use Draft7Validator because "draft-07" appears in the URL.

Verify backward compatibility:

- The test fixture `sample_json_schema` in conftest.py uses `"$schema": "http://json-schema.org/draft-07/schema#"` -- this contains "draft-07" so it will correctly route to Draft7Validator.
- Schemas without `$schema` will now use Draft 2020-12 instead of Draft 7. This is safe because Draft 2020-12 is backward compatible for standard object/array schemas. The only breaking change is tuple syntax (`items`/`additionalItems` â†’ `prefixItems`/`items`), which is unlikely in config file schemas.

**Part B: Verify outputSchema auto-generation**

After the timeout and schema changes, verify that FastMCP 3.x auto-generates outputSchema for tools with Pydantic return types. Create a quick verification by running:

```python
uv run python -c "
from mcp_json_yaml_toml.server import mcp
# List tools to verify outputSchema generation
import asyncio
async def check():
    tools = await mcp.list_tools()
    for tool in tools:
        has_output = hasattr(tool, 'outputSchema') and tool.outputSchema is not None
        print(f'{tool.name}: outputSchema={has_output}')
asyncio.run(check())
"
```

Expected: `data_query`, `data_convert`, `data_merge`, `constraint_validate`, and `constraint_list` should show `outputSchema=True` (these return Pydantic models). `data` and `data_schema` return `dict[str, Any]` and may or may not have outputSchema.

If the `list_tools()` API or `outputSchema` attribute name differs in FastMCP 3.x, adapt the verification accordingly. The key requirement is that Pydantic return types produce automatic outputSchema -- document the actual attribute name if different.

Run all tests after both changes: `uv run pytest`
Run linting: `uv run prek run --files packages/mcp_json_yaml_toml/services/schema_validation.py packages/mcp_json_yaml_toml/tools/data.py packages/mcp_json_yaml_toml/tools/query.py packages/mcp_json_yaml_toml/tools/schema.py packages/mcp_json_yaml_toml/tools/convert.py packages/mcp_json_yaml_toml/tools/constraints.py`
</action>
<verify>
Run: `uv run pytest` -- all tests pass.
Run: `uv run pytest -k "schema" -v` -- schema-related tests pass (especially tests with Draft 7 explicit $schema fixture).
Run: `uv run prek run --files packages/mcp_json_yaml_toml/services/schema_validation.py packages/mcp_json_yaml_toml/tools/data.py packages/mcp_json_yaml_toml/tools/query.py packages/mcp_json_yaml_toml/tools/schema.py packages/mcp_json_yaml_toml/tools/convert.py packages/mcp_json_yaml_toml/tools/constraints.py` -- all linting gates pass.
</verify>
<done>
JSON Schema default validator is Draft 2020-12 (SAFE-02 satisfied). Schemas with explicit $schema draft-07 still use Draft 7. outputSchema auto-generation verified for Pydantic-returning tools. All tests pass.
</done>
</task>

</tasks>

<verification>
1. `grep -n "timeout=" packages/mcp_json_yaml_toml/tools/*.py` -- shows timeout on all 7 tool decorators
2. `grep "Draft202012Validator" packages/mcp_json_yaml_toml/services/schema_validation.py` -- shows it as the default branch
3. `uv run pytest` -- all tests pass
4. `uv run pytest -k "schema" -v` -- schema tests pass with inverted default
5. outputSchema verified for Pydantic-returning tools via list_tools() introspection
</verification>

<success_criteria>

- All 7 tools have timeout parameters on @mcp.tool decorators (FMCP-03)
- File-processing tools use 60s timeout, in-memory tools use 10s timeout
- JSON Schema default validator is Draft 2020-12 (SAFE-02)
- Schemas with explicit Draft 7 $schema still use Draft7Validator
- outputSchema auto-generated for all Pydantic-returning tools (success criteria #4)
- All tests pass after changes
  </success_criteria>

<output>
After completion, create `.planning/phases/03-fastmcp-3x-migration/03-02-SUMMARY.md`
</output>
