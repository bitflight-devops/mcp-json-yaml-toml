---
phase: 07-architecture-refactoring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/mcp_json_yaml_toml/services/get_operations.py
  - packages/mcp_json_yaml_toml/services/mutation_operations.py
  - packages/mcp_json_yaml_toml/services/query_operations.py
  - packages/mcp_json_yaml_toml/services/data_operations.py
  - packages/mcp_json_yaml_toml/config.py
  - packages/mcp_json_yaml_toml/formats/base.py
  - packages/mcp_json_yaml_toml/services/schema_validation.py
  - packages/mcp_json_yaml_toml/tools/convert.py
  - packages/mcp_json_yaml_toml/tools/query.py
  - packages/mcp_json_yaml_toml/tools/schema.py
  - packages/mcp_json_yaml_toml/tools/diff.py
  - packages/mcp_json_yaml_toml/server.py
autonomous: true

must_haves:
  truths:
    - "data_operations.py delegates to focused sub-modules instead of containing 700+ lines of mixed concerns"
    - "Production code imports FormatType, execute_yq, YQExecutionError from backends.base/backends.yq instead of yq_wrapper shim"
    - "All existing tests pass without modification (backward-compat shim still works for test imports)"
  artifacts:
    - path: "packages/mcp_json_yaml_toml/services/get_operations.py"
      provides: "GET dispatch, structure handler, value handler, schema-get handler"
      contains: "_dispatch_get_operation"
    - path: "packages/mcp_json_yaml_toml/services/mutation_operations.py"
      provides: "SET/DELETE dispatch, TOML handlers, yq handlers, validation, optimization"
      contains: "_dispatch_set_operation"
    - path: "packages/mcp_json_yaml_toml/services/query_operations.py"
      provides: "Query response builder"
      contains: "_build_query_response"
    - path: "packages/mcp_json_yaml_toml/services/data_operations.py"
      provides: "Backward-compatible re-export facade for all data operation symbols"
      contains: "__all__"
  key_links:
    - from: "packages/mcp_json_yaml_toml/services/data_operations.py"
      to: "services/get_operations.py, services/mutation_operations.py, services/query_operations.py"
      via: "re-export imports"
      pattern: "from mcp_json_yaml_toml\\.services\\.(get|mutation|query)_operations import"
    - from: "packages/mcp_json_yaml_toml/tools/query.py"
      to: "packages/mcp_json_yaml_toml/backends/base.py"
      via: "direct import instead of shim"
      pattern: "from mcp_json_yaml_toml\\.backends\\.(base|yq) import"
---

<objective>
Split data_operations.py into focused service modules and migrate production imports off the deprecated yq_wrapper shim.

Purpose: Eliminate the god module (703 lines mixing GET/SET/DELETE/query concerns) and remove indirect imports through the yq_wrapper shim, both of which increase maintenance burden and obscure dependencies.

Output: Three focused service modules (get, mutation, query), a backward-compatible data_operations.py facade, and production code importing directly from backends.
</objective>

<execution_context>
@/home/ubuntulinuxqa2/.claude/get-shit-done/workflows/execute-plan.md
@/home/ubuntulinuxqa2/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/mcp_json_yaml_toml/services/data_operations.py
@packages/mcp_json_yaml_toml/yq_wrapper.py
@packages/mcp_json_yaml_toml/backends/base.py
@packages/mcp_json_yaml_toml/backends/yq.py
@packages/mcp_json_yaml_toml/server.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Split data_operations.py into focused service modules (ARCH-06)</name>
  <files>
    packages/mcp_json_yaml_toml/services/get_operations.py
    packages/mcp_json_yaml_toml/services/mutation_operations.py
    packages/mcp_json_yaml_toml/services/query_operations.py
    packages/mcp_json_yaml_toml/services/data_operations.py
    packages/mcp_json_yaml_toml/server.py
  </files>
  <action>
Split `services/data_operations.py` (703 lines) into three focused modules. The current file mixes GET dispatch/handlers, SET/DELETE dispatch/handlers, and query response building.

**Create `services/get_operations.py`** containing:

- `_dispatch_get_operation()` (dispatcher)
- `_handle_data_get_schema()` (schema GET handler)
- `_handle_data_get_structure()` (structure/keys handler)
- `_handle_data_get_value()` (value GET handler)
- `is_schema()` type guard

These functions share read-only data flow: file -> yq query -> format -> paginate -> response.

**Create `services/mutation_operations.py`** containing:

- `_dispatch_set_operation()` (SET dispatcher)
- `_dispatch_delete_operation()` (DELETE dispatcher)
- `_handle_data_set()` (SET handler)
- `_handle_data_delete()` (DELETE handler)
- `_set_toml_value_handler()` (TOML SET)
- `_delete_toml_key_handler()` (TOML DELETE)
- `_delete_yq_key_handler()` (yq DELETE)
- `_optimize_yaml_if_needed()` (YAML post-write optimization)
- `_validate_and_write_content()` (write with schema validation)

These functions share the write flow: parse value -> execute mutation -> validate -> write -> optimize.

**Create `services/query_operations.py`** containing:

- `_build_query_response()` (query result builder)

This is a standalone function used only by `tools/query.py`.

**Convert `services/data_operations.py`** into a backward-compatible re-export facade:

- Import all symbols from the three new modules
- Preserve the existing `__all__` list exactly
- Add `# noqa: F401` on re-export imports
- Add module docstring noting it is a backward-compat shim (like yq_wrapper.py pattern)

**Update `server.py`** import paths:

- Change `from mcp_json_yaml_toml.services.data_operations import` to import from the specific sub-modules where server.py uses them.
- Alternative: Keep server.py importing from data_operations.py (facade) for simplicity. Choose whichever is cleaner -- server.py is a re-export shell itself, so importing from the facade is acceptable.

Each new module should:

1. Have `from __future__ import annotations` at top
2. Import from `mcp_json_yaml_toml.backends.base` and `mcp_json_yaml_toml.backends.yq` (NOT yq_wrapper) for FormatType, YQExecutionError, execute_yq
3. Use `if TYPE_CHECKING:` for SchemaInfo, SchemaManager, Path
4. Have an `__all__` list
5. Preserve all existing function signatures, docstrings, and behavior exactly
   </action>
   <verify>

```bash
uv run pytest packages/mcp_json_yaml_toml/tests/ -x -q
uv run prek run --files packages/mcp_json_yaml_toml/services/get_operations.py packages/mcp_json_yaml_toml/services/mutation_operations.py packages/mcp_json_yaml_toml/services/query_operations.py packages/mcp_json_yaml_toml/services/data_operations.py packages/mcp_json_yaml_toml/server.py
```

  </verify>
  <done>
data_operations.py is a thin re-export facade. GET handlers in get_operations.py, SET/DELETE handlers in mutation_operations.py, query builder in query_operations.py. All tests pass. All linters pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate production imports from yq_wrapper shim to backends modules (ARCH-08)</name>
  <files>
    packages/mcp_json_yaml_toml/config.py
    packages/mcp_json_yaml_toml/formats/base.py
    packages/mcp_json_yaml_toml/services/schema_validation.py
    packages/mcp_json_yaml_toml/tools/convert.py
    packages/mcp_json_yaml_toml/tools/query.py
    packages/mcp_json_yaml_toml/tools/schema.py
    packages/mcp_json_yaml_toml/tools/diff.py
  </files>
  <action>
Migrate 7 production files that import from `mcp_json_yaml_toml.yq_wrapper` to import directly from `mcp_json_yaml_toml.backends.base` (for types) and `mcp_json_yaml_toml.backends.yq` (for functions).

**Import mapping** (apply to each file):

- `from mcp_json_yaml_toml.yq_wrapper import FormatType` -> `from mcp_json_yaml_toml.backends.base import FormatType`
- `from mcp_json_yaml_toml.yq_wrapper import YQExecutionError` -> `from mcp_json_yaml_toml.backends.base import YQExecutionError`
- `from mcp_json_yaml_toml.yq_wrapper import YQError` -> `from mcp_json_yaml_toml.backends.base import YQError`
- `from mcp_json_yaml_toml.yq_wrapper import execute_yq` -> `from mcp_json_yaml_toml.backends.yq import execute_yq`

**Files to update** (current import -> new import):

1. `config.py` line 16: `from mcp_json_yaml_toml.yq_wrapper import FormatType` -> `from mcp_json_yaml_toml.backends.base import FormatType`

2. `formats/base.py` line 17: `from mcp_json_yaml_toml.yq_wrapper import FormatType, YQExecutionError` -> `from mcp_json_yaml_toml.backends.base import FormatType, YQExecutionError`

3. `services/schema_validation.py` line 21: `from mcp_json_yaml_toml.yq_wrapper import FormatType, YQError, execute_yq` -> split into:
   - `from mcp_json_yaml_toml.backends.base import FormatType, YQError`
   - `from mcp_json_yaml_toml.backends.yq import execute_yq`

4. `tools/convert.py` line 16: `from mcp_json_yaml_toml.yq_wrapper import FormatType, YQExecutionError, execute_yq` -> split into:
   - `from mcp_json_yaml_toml.backends.base import FormatType, YQExecutionError`
   - `from mcp_json_yaml_toml.backends.yq import execute_yq`

5. `tools/query.py` line 21: same pattern as convert.py

6. `tools/schema.py` line 15: same pattern as convert.py

7. `tools/diff.py` line 19: same pattern as convert.py

**Do NOT change test files** -- tests are permitted to import from the shim (`yq_wrapper`) for backward compatibility. The shim remains functional.

Note: The new service modules created in Task 1 (get_operations.py, mutation_operations.py, query_operations.py) should already import from backends directly. If Task 1 used yq_wrapper imports in them, update those too.
</action>
<verify>

```bash
uv run pytest packages/mcp_json_yaml_toml/tests/ -x -q
uv run prek run --files packages/mcp_json_yaml_toml/config.py packages/mcp_json_yaml_toml/formats/base.py packages/mcp_json_yaml_toml/services/schema_validation.py packages/mcp_json_yaml_toml/tools/convert.py packages/mcp_json_yaml_toml/tools/query.py packages/mcp_json_yaml_toml/tools/schema.py packages/mcp_json_yaml_toml/tools/diff.py
# Verify no production file still imports from yq_wrapper (tests excluded)
grep -r "from mcp_json_yaml_toml.yq_wrapper import" packages/mcp_json_yaml_toml/ --include="*.py" | grep -v tests/ | grep -v __pycache__
# Only yq_wrapper.py itself and data_operations.py (if still re-exporting) should appear
```

  </verify>
  <done>
All production code (config.py, formats/base.py, services/schema_validation.py, tools/convert.py, tools/query.py, tools/schema.py, tools/diff.py) imports from backends.base and backends.yq. yq_wrapper.py shim remains for backward compat and test imports. Zero production files import from yq_wrapper. All tests pass. All linters pass.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **ARCH-06 verification**: `wc -l packages/mcp_json_yaml_toml/services/data_operations.py` should be <60 lines (re-export facade). `get_operations.py`, `mutation_operations.py`, `query_operations.py` should exist.
2. **ARCH-08 verification**: `grep -r "from mcp_json_yaml_toml.yq_wrapper import" packages/mcp_json_yaml_toml/ --include="*.py" | grep -v tests/ | grep -v __pycache__ | grep -v yq_wrapper.py` should return empty (no production code using shim).
3. **Full test suite**: `uv run pytest packages/mcp_json_yaml_toml/tests/ -x -q` passes.
4. **Full lint**: `uv run prek run --files <all modified files>` passes.
   </verification>

<success_criteria>

- data_operations.py is a re-export facade under 60 lines
- Three focused service modules exist with clear responsibility boundaries
- Zero production files import from yq_wrapper (only tests and the shim itself)
- All 60+ existing tests pass unchanged
- All quality gates (ruff, mypy, basedpyright) pass
  </success_criteria>

<output>
After completion, create `.planning/phases/07-architecture-refactoring/07-01-SUMMARY.md`
</output>
