---
phase: 01-architectural-foundation
plan: 04
type: execute
wave: 2
depends_on: ["01-01", "01-02"]
files_modified:
  - packages/mcp_json_yaml_toml/formats/__init__.py
  - packages/mcp_json_yaml_toml/formats/base.py
  - packages/mcp_json_yaml_toml/server.py
autonomous: true
must_haves:
  truths:
    - "Format detection and value parsing exist in formats/base.py (ARCH-02)"
    - "server.py imports format functions from formats.base"
    - "All 395 existing tests pass without modification"
    - "All quality gates pass (ruff, mypy, basedpyright, pytest with coverage)"
  artifacts:
    - path: "packages/mcp_json_yaml_toml/formats/__init__.py"
      provides: "Package marker for formats module"
    - path: "packages/mcp_json_yaml_toml/formats/base.py"
      provides: "Format detection, content parsing for validation, value parsing for SET operations"
      exports:
        [
          "_detect_file_format",
          "_parse_content_for_validation",
          "_parse_set_value",
          "_parse_typed_json",
        ]
    - path: "packages/mcp_json_yaml_toml/server.py"
      provides: "Imports format functions from formats.base, no longer defines them inline"
      contains: "from mcp_json_yaml_toml.formats.base import"
  key_links:
    - from: "packages/mcp_json_yaml_toml/formats/base.py"
      to: "packages/mcp_json_yaml_toml/backends/base.py"
      via: "Imports FormatType enum for format detection"
      pattern: "from mcp_json_yaml_toml\\.backends\\.base import FormatType"
    - from: "packages/mcp_json_yaml_toml/server.py"
      to: "packages/mcp_json_yaml_toml/formats/base.py"
      via: "server.py imports format functions from formats.base"
      pattern: "from mcp_json_yaml_toml\\.formats\\.base import"
---

<objective>
Extract format detection and value parsing from server.py into formats/base.py, then run full verification gate across the entire phase.

Purpose: Format detection (\_detect_file_format), content parsing for validation (\_parse_content_for_validation), and value parsing for SET operations (\_parse_set_value, \_parse_typed_json) are pure utility functions that operate on format types and raw data. Extracting them to formats/base.py completes ARCH-02 and creates the foundation for Phase 2's formats/ expansion. The final verification gate confirms all five Phase 1 success criteria are met.

Output: formats/ package with base.py. server.py further reduced (~80 lines). Full phase verification passing.
</objective>

<execution_context>
@/home/ubuntulinuxqa2/.claude/get-shit-done/workflows/execute-plan.md
@/home/ubuntulinuxqa2/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-architectural-foundation/01-RESEARCH.md
@.planning/phases/01-architectural-foundation/01-01-SUMMARY.md
@.planning/phases/01-architectural-foundation/01-02-SUMMARY.md
@.planning/codebase/CONVENTIONS.md
@packages/mcp_json_yaml_toml/server.py
@packages/mcp_json_yaml_toml/backends/base.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create formats/base.py and update server.py imports</name>
  <files>
    packages/mcp_json_yaml_toml/formats/__init__.py
    packages/mcp_json_yaml_toml/formats/base.py
    packages/mcp_json_yaml_toml/server.py
  </files>
  <action>
Create the `formats/` package directory under `packages/mcp_json_yaml_toml/`.

**formats/**init**.py**: Empty package marker with a module docstring:

```python
"""Format detection, parsing, and value handling modules."""
```

**formats/base.py**: Extract the following from `server.py`:

1. `_detect_file_format(file_path: str | Path) -> FormatType | None` (lines ~311-334 of server.py) -- Maps file extension to FormatType. Pure function, no side effects.

2. `_parse_content_for_validation(content: str, input_format: FormatType | str) -> Any | None` (lines ~69-94 of server.py) -- Parses string content into Python data structure based on format. Uses orjson for JSON, ruamel.yaml for YAML, tomlkit for TOML.

3. `_parse_set_value(value: str, value_type: str) -> Any` (lines ~628-662 of server.py) -- Parses a string value based on declared type (string, number, boolean, null, json). Used by SET operations.

4. `_parse_typed_json(value: str) -> Any` (lines ~601-625 of server.py) -- Parses a JSON string value with type validation. Called by \_parse_set_value.

Imports needed:

- `from __future__ import annotations`
- `from pathlib import Path`
- `from typing import Any`
- `import orjson`
- `import tomlkit`
- `from ruamel.yaml import YAML`
- `from fastmcp.exceptions import ToolError` (if the extracted functions raise ToolError -- check server.py)
- `from mcp_json_yaml_toml.backends.base import FormatType` (from Plan 01)

Note: If `_parse_content_for_validation` or `_parse_set_value` raise `ToolError`, that import is needed. If they raise standard Python exceptions, ToolError is not needed. Read the actual function bodies to determine this.

Follow project conventions: `from __future__ import annotations` first, Google-style docstrings, type annotations. Define `__all__`.

**Update server.py:**

1. Remove the extracted function definitions from server.py.

2. Add import at the top of server.py (local imports section):

```python
from mcp_json_yaml_toml.formats.base import (
    _detect_file_format,
    _parse_content_for_validation,
    _parse_set_value,
    _parse_typed_json,
)
```

3. Verify that server.py's remaining code references these functions correctly. They are called from:
   - `_detect_file_format`: called in data(), data_query(), data_convert(), data_merge(), data_schema()
   - `_parse_content_for_validation`: called in \_validate_and_write_content()
   - `_parse_set_value`: called in \_handle_data_set()
   - `_parse_typed_json`: only called by \_parse_set_value (if both move together, no server.py reference remains)

If `_parse_typed_json` is ONLY called by `_parse_set_value` and both move to formats/base.py, then server.py does NOT need to import `_parse_typed_json`. Only import what server.py's remaining code actually calls.

Run quality gates: `uv run prek run --files packages/mcp_json_yaml_toml/server.py packages/mcp_json_yaml_toml/formats/base.py`
</action>
<verify>
Run: `python -c "from mcp_json_yaml_toml.formats.base import _detect_file_format, _parse_content_for_validation, _parse_set_value; print('formats.base OK')"` -- must succeed.

Run: `uv run pytest -x -q` -- all 395 tests must pass.

Run: `uv run ruff check packages/mcp_json_yaml_toml/formats/ packages/mcp_json_yaml_toml/server.py` -- must pass.

Run: `uv run mypy packages/mcp_json_yaml_toml/ --show-error-codes` -- must pass on entire package.

Run: `uv run basedpyright packages/mcp_json_yaml_toml/` -- must pass on entire package (excluding tests if basedpyright config scopes it).
</verify>
<done>
formats/base.py contains \_detect_file_format, \_parse_content_for_validation, \_parse_set_value, \_parse_typed_json. server.py imports from formats.base. All 395 tests pass. All type checkers pass. ARCH-02 requirement satisfied.
</done>
</task>

<task type="auto">
  <name>Task 2: Full Phase 1 verification gate</name>
  <files></files>
  <action>
Run the complete quality gate suite to verify all Phase 1 success criteria. This task modifies no files -- it only verifies.

**Phase 1 Success Criteria verification:**

1. **ARCH-01**: Pagination logic in services/pagination.py
   - Verify: `python -c "from mcp_json_yaml_toml.services.pagination import _paginate_result, _encode_cursor, _decode_cursor; print('ARCH-01 OK')"`

2. **ARCH-02**: Format detection and value parsing in formats/base.py
   - Verify: `python -c "from mcp_json_yaml_toml.formats.base import _detect_file_format, _parse_content_for_validation, _parse_set_value; print('ARCH-02 OK')"`

3. **ARCH-03**: Binary lifecycle decoupled from query execution
   - Verify: `python -c "from mcp_json_yaml_toml.backends.binary_manager import get_yq_binary_path; from mcp_json_yaml_toml.backends.yq import execute_yq; print('ARCH-03 OK')"`

4. **ARCH-04**: QueryBackend protocol with YqBackend implementation
   - Verify: `python -c "from mcp_json_yaml_toml.backends.base import QueryBackend; from mcp_json_yaml_toml.backends.yq import YqBackend; print('ARCH-04 OK')"`

5. **All existing tests pass without modification**
   - Verify: `uv run pytest -q` (must show 395 passed)

6. **SAFE-01**: ruamel.yaml pinned <0.19
   - Verify: `grep 'ruamel.yaml>=0.18.0,<0.19' pyproject.toml`

**Full quality gate suite:**

- `uv run ruff format --check packages/mcp_json_yaml_toml/`
- `uv run ruff check packages/mcp_json_yaml_toml/`
- `uv run mypy packages/ --show-error-codes`
- `uv run basedpyright packages/`
- `uv run pytest -q` (all 395 tests, with coverage report)

**Structural verification:**

- Confirm directory structure matches research target:
  ```
  packages/mcp_json_yaml_toml/
    backends/__init__.py
    backends/base.py
    backends/binary_manager.py
    backends/yq.py
    services/__init__.py
    services/pagination.py
    formats/__init__.py
    formats/base.py
    yq_wrapper.py  (shim, <50 lines)
    server.py      (reduced, ~1600 lines)
  ```

If any verification fails, diagnose and fix the issue. The fix should be minimal and targeted -- do not re-architect; instead, fix the specific failing check (missing import, type annotation, etc.).
</action>
<verify>
All commands listed in the action section must succeed. Specifically:

- 395 tests pass
- All 5 success criteria verified via import checks
- ruff format, ruff check, mypy, basedpyright all clean
- Coverage >= 60%
  </verify>
  <done>
  All Phase 1 success criteria verified: ARCH-01 (pagination extracted), ARCH-02 (format detection extracted), ARCH-03 (binary lifecycle decoupled), ARCH-04 (QueryBackend protocol + YqBackend), SAFE-01 (ruamel.yaml pinned). All 395 tests pass. All quality gates pass. Coverage >= 60%.
  </done>
  </task>

</tasks>

<verification>
1. All 5 Phase 1 success criteria verified via import checks
2. `uv run pytest -q` -- 395 tests passed
3. `uv run ruff format --check packages/mcp_json_yaml_toml/` -- clean
4. `uv run ruff check packages/mcp_json_yaml_toml/` -- clean
5. `uv run mypy packages/ --show-error-codes` -- clean
6. `uv run basedpyright packages/` -- clean
7. Coverage >= 60%
8. Directory structure matches target layout from research
</verification>

<success_criteria>

- formats/base.py exists with format detection and value parsing functions
- server.py imports from formats.base (reduced by ~80 more lines)
- All 395 tests pass without modification
- All Phase 1 requirements verified: ARCH-01, ARCH-02, ARCH-03, ARCH-04, SAFE-01
- Full quality gate suite passes (format, lint, mypy, basedpyright, pytest)
- Phase 1 is complete and ready for Phase 2
  </success_criteria>

<output>
After completion, create `.planning/phases/01-architectural-foundation/01-04-SUMMARY.md`
</output>
