---
phase: 01-architectural-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - packages/mcp_json_yaml_toml/backends/__init__.py
  - packages/mcp_json_yaml_toml/backends/base.py
autonomous: true
must_haves:
  truths:
    - "FormatType, YQResult, YQError, YQExecutionError, YQBinaryNotFoundError are importable from backends.base"
    - "QueryBackend Protocol is defined with execute() and validate() methods"
    - "ruamel.yaml dependency has upper bound <0.19 in pyproject.toml"
    - "All 395 existing tests still pass (no behavior change)"
  artifacts:
    - path: "packages/mcp_json_yaml_toml/backends/__init__.py"
      provides: "Package marker for backends module"
    - path: "packages/mcp_json_yaml_toml/backends/base.py"
      provides: "QueryBackend protocol, FormatType enum, YQResult model, error classes"
      exports:
        [
          "QueryBackend",
          "FormatType",
          "YQResult",
          "YQError",
          "YQExecutionError",
          "YQBinaryNotFoundError",
        ]
    - path: "pyproject.toml"
      provides: "SAFE-01 ruamel.yaml pin"
      contains: "ruamel.yaml>=0.18.0,<0.19"
  key_links:
    - from: "packages/mcp_json_yaml_toml/backends/base.py"
      to: "packages/mcp_json_yaml_toml/yq_wrapper.py"
      via: "Types defined in base.py are currently defined in yq_wrapper.py -- base.py is the new canonical location, yq_wrapper.py will re-export in Plan 03"
      pattern: "class FormatType|class YQResult|class YQError"
---

<objective>
Create the backends/ package with foundational types and the QueryBackend protocol, plus pin ruamel.yaml (SAFE-01).

Purpose: Establishes the type foundation that all other extraction plans depend on. FormatType, YQResult, and error classes move from yq_wrapper.py to backends/base.py as their canonical home. The QueryBackend Protocol defines the pluggable backend interface that YqBackend will implement in Plan 03. SAFE-01 pins ruamel.yaml<0.19 to prevent zig-compiler deployment failures.

Output: backends/ package with base.py containing all shared types and Protocol definition. pyproject.toml with SAFE-01 pin applied.
</objective>

<execution_context>
@/home/ubuntulinuxqa2/.claude/get-shit-done/workflows/execute-plan.md
@/home/ubuntulinuxqa2/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-architectural-foundation/01-RESEARCH.md
@.planning/codebase/CONVENTIONS.md
@.planning/codebase/ARCHITECTURE.md
@packages/mcp_json_yaml_toml/yq_wrapper.py
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create backends/base.py with types and QueryBackend Protocol</name>
  <files>
    packages/mcp_json_yaml_toml/backends/__init__.py
    packages/mcp_json_yaml_toml/backends/base.py
  </files>
  <action>
Create the `backends/` package directory under `packages/mcp_json_yaml_toml/`.

**backends/**init**.py**: Empty package marker with a module docstring:

```python
"""Backend abstraction layer for query execution engines."""
```

**backends/base.py**: Extract the following from `yq_wrapper.py` and define the Protocol:

1. Copy `FormatType` enum (StrEnum, lines 64-73 of yq_wrapper.py) -- preserve exact member names and values (JSON, YAML, TOML, XML, CSV, TSV, PROPS).

2. Copy `YQResult` Pydantic model (lines 55-62 of yq_wrapper.py) -- preserve exact field names (stdout, stderr, returncode, data) and types.

3. Copy error class hierarchy (lines 36-52 of yq_wrapper.py):
   - `YQError(Exception)` with `message` and `stderr` attributes
   - `YQBinaryNotFoundError(YQError)` -- no additional attributes
   - `YQExecutionError(YQError)` with `returncode` attribute

4. Define `QueryBackend` as a `typing.Protocol`:

```python
class QueryBackend(Protocol):
    """Protocol for pluggable query execution backends."""

    def execute(
        self,
        expression: str,
        input_data: str | None = None,
        input_file: Path | str | None = None,
        input_format: FormatType = FormatType.YAML,
        output_format: FormatType = FormatType.JSON,
        in_place: bool = False,
        null_input: bool = False,
    ) -> YQResult: ...

    def validate(self) -> tuple[bool, str]: ...
```

5. Define `__all__` listing all public exports.

Follow project conventions: `from __future__ import annotations` first, Google-style docstrings, type annotations on all definitions. Use absolute imports only.

IMPORTANT: Do NOT modify yq_wrapper.py in this task. The types currently live in both locations. Plan 03 will convert yq_wrapper.py to a shim that re-exports from base.py. For now, base.py is a parallel definition -- this is intentional to keep yq_wrapper.py functional while backends/ is built incrementally.
</action>
<verify>
Run: `python -c "from mcp_json_yaml_toml.backends.base import QueryBackend, FormatType, YQResult, YQError, YQExecutionError, YQBinaryNotFoundError; print('All imports OK')"` -- must succeed.

Run: `uv run mypy packages/mcp_json_yaml_toml/backends/ --show-error-codes` -- must pass with no errors.

Run: `uv run basedpyright packages/mcp_json_yaml_toml/backends/` -- must pass.

Run: `uv run ruff check packages/mcp_json_yaml_toml/backends/` -- must pass.

Run: `uv run pytest -x -q` -- all 395 tests must pass (no existing behavior changed).
</verify>
<done>
backends/base.py exists with FormatType, YQResult, YQError, YQBinaryNotFoundError, YQExecutionError, and QueryBackend Protocol. All type checkers pass. All 395 existing tests pass unchanged.
</done>
</task>

<task type="auto">
  <name>Task 2: Pin ruamel.yaml <0.19 (SAFE-01)</name>
  <files>pyproject.toml</files>
  <action>
In `pyproject.toml`, find the ruamel.yaml dependency line (currently line 37):
```
"ruamel.yaml>=0.18.0", # 0.19.x has different API - keep 0.18 for stability
```

Change it to:

```
"ruamel.yaml>=0.18.0,<0.19",  # 0.19.x requires zig compiler for ruamel.yaml.clibz
```

This adds the upper bound `<0.19` to prevent automatic upgrade to 0.19.x, which replaces `ruamel.yaml.clib` with `ruamel.yaml.clibz` (a zig-compiled variant that fails in Docker slim images and CI without zig toolchain).

After editing, run `uv lock` to update the lockfile. The currently installed version is 0.18.17, which is within the new range, so no actual package changes should occur.
</action>
<verify>
Run: `grep "ruamel.yaml" pyproject.toml` -- must show `>=0.18.0,<0.19`.

Run: `uv lock` -- must succeed without errors.

Run: `uv run pytest -x -q` -- all 395 tests must still pass.
</verify>
<done>
pyproject.toml pins ruamel.yaml to >=0.18.0,<0.19. Lock file updated. All tests pass. SAFE-01 requirement satisfied.
</done>
</task>

</tasks>

<verification>
1. `python -c "from mcp_json_yaml_toml.backends.base import QueryBackend, FormatType, YQResult, YQError"` succeeds
2. `grep 'ruamel.yaml>=0.18.0,<0.19' pyproject.toml` returns a match
3. `uv run pytest -x -q` -- all 395 tests pass
4. `uv run mypy packages/mcp_json_yaml_toml/backends/ --show-error-codes` -- clean
5. `uv run basedpyright packages/mcp_json_yaml_toml/backends/` -- clean
6. `uv run ruff check packages/mcp_json_yaml_toml/backends/` -- clean
</verification>

<success_criteria>

- backends/base.py contains FormatType, YQResult, YQError, YQBinaryNotFoundError, YQExecutionError, QueryBackend
- QueryBackend is a typing.Protocol with execute() and validate() methods
- pyproject.toml has ruamel.yaml>=0.18.0,<0.19
- All 395 tests pass without modification
- All type checkers and linters pass on new code
  </success_criteria>

<output>
After completion, create `.planning/phases/01-architectural-foundation/01-01-SUMMARY.md`
</output>
