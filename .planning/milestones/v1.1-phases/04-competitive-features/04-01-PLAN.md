---
phase: 04-competitive-features
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - packages/mcp_json_yaml_toml/models/responses.py
  - packages/mcp_json_yaml_toml/services/diff_operations.py
  - packages/mcp_json_yaml_toml/tools/diff.py
  - packages/mcp_json_yaml_toml/server.py
  - packages/mcp_json_yaml_toml/tests/test_diff.py
autonomous: true

must_haves:
  truths:
    - "data_diff tool compares two configuration files and returns structured differences"
    - "Cross-format comparison works (e.g., JSON file vs YAML file)"
    - "Identical files return has_differences=false with empty differences"
    - "List ordering can be ignored via ignore_order parameter"
    - "Tool follows existing patterns (thin decorator -> service -> response model)"
  artifacts:
    - path: "packages/mcp_json_yaml_toml/services/diff_operations.py"
      provides: "compute_diff business logic using DeepDiff"
      contains: "def compute_diff"
    - path: "packages/mcp_json_yaml_toml/tools/diff.py"
      provides: "data_diff tool decorator with MCP annotations"
      contains: "@mcp.tool"
    - path: "packages/mcp_json_yaml_toml/models/responses.py"
      provides: "DiffResponse Pydantic model"
      contains: "class DiffResponse"
    - path: "packages/mcp_json_yaml_toml/tests/test_diff.py"
      provides: "Tests for diff tool and service"
      min_lines: 80
  key_links:
    - from: "packages/mcp_json_yaml_toml/tools/diff.py"
      to: "packages/mcp_json_yaml_toml/services/diff_operations.py"
      via: "import compute_diff"
      pattern: "from mcp_json_yaml_toml\\.services\\.diff_operations import"
    - from: "packages/mcp_json_yaml_toml/tools/diff.py"
      to: "packages/mcp_json_yaml_toml/models/responses.py"
      via: "import DiffResponse"
      pattern: "from mcp_json_yaml_toml\\.models\\.responses import DiffResponse"
    - from: "packages/mcp_json_yaml_toml/server.py"
      to: "packages/mcp_json_yaml_toml/tools/diff.py"
      via: "tool registration import"
      pattern: "from mcp_json_yaml_toml\\.tools\\.diff import data_diff"
---

<objective>
Add `data_diff` tool for structured comparison of two configuration files, supporting cross-format comparison (JSON vs YAML vs TOML) using DeepDiff.

Purpose: FEAT-01 — Config file diffing is a high-value differentiator. Users comparing staging vs production configs, tracking config drift, or reviewing changes across format boundaries need structured diff output.

Output: Working `data_diff` tool registered in MCP server with DiffResponse model, diff service logic, and comprehensive tests.
</objective>

<execution_context>
@/home/ubuntulinuxqa2/.claude/get-shit-done/workflows/execute-plan.md
@/home/ubuntulinuxqa2/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-competitive-features/04-RESEARCH.md

Key patterns to follow:

- Tool pattern: See tools/convert.py (data_merge) for two-file-input tool with @mcp.tool decorator, annotations, and ToolError
- Response model: See models/responses.py (MergeResponse) for ToolResponse subclass pattern with \_DictAccessMixin
- Service pattern: See services/data_operations.py for service-layer function signatures
- Format detection: Use \_detect_file_format from formats/base.py, parse via yq -> JSON -> orjson pipeline
- Server registration: See server.py for import + **all** re-export pattern
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Add deepdiff dependency, DiffResponse model, and diff service</name>
  <files>
    pyproject.toml
    packages/mcp_json_yaml_toml/models/responses.py
    packages/mcp_json_yaml_toml/services/diff_operations.py
  </files>
  <action>
1. Add deepdiff dependency:
   ```bash
   uv add "deepdiff>=8.0.0"
   ```

2. Add DiffResponse to models/responses.py (before **all**):

   ```python
   class DiffResponse(ToolResponse):
       """Response for data_diff tool."""
       file1: str = ""
       file2: str = ""
       file1_format: str = ""
       file2_format: str = ""
       has_differences: bool = False
       summary: str = ""
       differences: dict[str, Any] | None = None  # DeepDiff to_dict() output
       statistics: dict[str, int] | None = None    # Count of changes by type
   ```

   Add "DiffResponse" to the **all** list in responses.py.

3. Create services/diff_operations.py:
   - Function `compute_diff(data1: Any, data2: Any, ignore_order: bool = False) -> dict[str, Any]` that wraps DeepDiff with verbose_level=2 and returns diff.to_dict().
   - Function `build_diff_statistics(diff_dict: dict[str, Any]) -> dict[str, int]` that counts changes by type (values_changed, dictionary_item_added, dictionary_item_removed, iterable_item_added, iterable_item_removed, type_changes).
   - Function `build_diff_summary(stats: dict[str, int], has_differences: bool) -> str` that produces a human-readable one-line summary like "3 values changed, 1 item added, 2 items removed".
   - Add proper **all** exports.
   - Use `from __future__ import annotations` and proper type annotations.
     </action>
     <verify>

```bash
uv run python -c "from deepdiff import DeepDiff; d = DeepDiff({'a': 1}, {'a': 2}); print(d.to_dict())"
uv run python -c "from mcp_json_yaml_toml.models.responses import DiffResponse; r = DiffResponse(success=True, has_differences=True); print(r)"
uv run python -c "from mcp_json_yaml_toml.services.diff_operations import compute_diff; print(compute_diff({'a': 1}, {'a': 2}))"
uv run prek run --files packages/mcp_json_yaml_toml/models/responses.py packages/mcp_json_yaml_toml/services/diff_operations.py
```

  </verify>
  <done>DiffResponse model importable, compute_diff returns DeepDiff to_dict() output, build_diff_statistics counts change types, all linting passes</done>
</task>

<task type="auto">
  <name>Task 2: Create data_diff tool, register in server, and add tests</name>
  <files>
    packages/mcp_json_yaml_toml/tools/diff.py
    packages/mcp_json_yaml_toml/server.py
    packages/mcp_json_yaml_toml/tests/test_diff.py
  </files>
  <action>
1. Create tools/diff.py following the data_merge pattern in tools/convert.py:
   - Import mcp from server, DiffResponse from models.responses, compute_diff/build_diff_statistics/build_diff_summary from services.diff_operations
   - @mcp.tool decorator with timeout=60.0 and annotations: readOnlyHint=True, destructiveHint=False, idempotentHint=True, openWorldHint=False
   - Parameters:
     - file_path1: Annotated[str, Field(description="Path to first file (base)")]
     - file_path2: Annotated[str, Field(description="Path to second file (comparison)")]
     - ignore_order: Annotated[bool, Field(description="Ignore list/array ordering in comparison")] = False
   - Return type: DiffResponse
   - Implementation:
     a. Resolve both paths, check existence (raise ToolError if not found)
     b. Detect formats via _detect_file_format, check is_format_enabled
     c. Parse both files to Python dicts via execute_yq(input_file=path, input_format=fmt, output_format=FormatType.JSON) -> use result.data
     d. Call compute_diff(data1, data2, ignore_order=ignore_order)
     e. Build statistics and summary
     f. Return DiffResponse with all fields populated
   - Docstring: "Compare two configuration files and return structured differences."

2. Update server.py:
   - Add import: `from mcp_json_yaml_toml.tools.diff import data_diff  # noqa: E402`
   - Add "data_diff" to **all** list (in the Tools section)

3. Create tests/test_diff.py:
   - Test compute_diff with identical dicts -> empty diff
   - Test compute_diff with value changes -> values_changed in output
   - Test compute_diff with added/removed keys -> dictionary_item_added/removed
   - Test compute_diff with ignore_order=True on reordered lists -> empty diff
   - Test compute_diff with ignore_order=False on reordered lists -> has differences
   - Test build_diff_statistics produces correct counts
   - Test build_diff_summary produces human-readable string
   - Test data_diff tool with two JSON fixture files (identical)
   - Test data_diff tool with two JSON fixture files (different)
   - Test data_diff tool with cross-format comparison (JSON vs YAML with same content)
   - Test data_diff tool with missing file -> ToolError
   - Use tmp_path fixture for test files. Create fixture files inline using Path.write_text.
   - Import data_diff from mcp_json_yaml_toml.tools.diff (call directly, not via MCP protocol)
     </action>
     <verify>

```bash
uv run pytest packages/mcp_json_yaml_toml/tests/test_diff.py -v
uv run pytest -x  # Full suite
uv run prek run --files packages/mcp_json_yaml_toml/tools/diff.py packages/mcp_json_yaml_toml/server.py packages/mcp_json_yaml_toml/tests/test_diff.py
```

  </verify>
  <done>data_diff tool registered and callable, all diff tests pass, full test suite passes, linting clean</done>
</task>

</tasks>

<verification>
1. `uv run pytest packages/mcp_json_yaml_toml/tests/test_diff.py -v` — all diff-specific tests pass
2. `uv run pytest -x` — full test suite passes (no regressions)
3. `uv run prek run --files packages/mcp_json_yaml_toml/tools/diff.py packages/mcp_json_yaml_toml/services/diff_operations.py packages/mcp_json_yaml_toml/models/responses.py packages/mcp_json_yaml_toml/server.py` — all quality gates pass
4. `uv run python -c "from mcp_json_yaml_toml.server import data_diff; print(data_diff)"` — tool is importable from server module
</verification>

<success_criteria>

- data_diff tool returns DiffResponse with structured differences between two config files
- Cross-format comparison works (JSON vs YAML produces semantic diff)
- Identical files produce has_differences=false
- ignore_order parameter controls list comparison behavior
- All existing tests continue to pass
- All linting gates pass (ruff, mypy, basedpyright)
  </success_criteria>

<output>
After completion, create `.planning/phases/04-competitive-features/04-01-SUMMARY.md`
</output>
