---
phase: 02-tool-layer-refactoring
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - packages/mcp_json_yaml_toml/services/__init__.py
  - packages/mcp_json_yaml_toml/services/data_operations.py
  - packages/mcp_json_yaml_toml/server.py
autonomous: true

must_haves:
  truths:
    - "All data CRUD business logic exists in services/data_operations.py, not in server.py"
    - "server.py tool functions delegate to service layer functions"
    - "All 395 existing tests pass without modification"
  artifacts:
    - path: "packages/mcp_json_yaml_toml/services/data_operations.py"
      provides: "All _handle_*, _dispatch_*, _build_query_response, _validate_and_write_content, is_schema functions"
      contains: "_dispatch_get_operation"
    - path: "packages/mcp_json_yaml_toml/server.py"
      provides: "Tool decorators calling service layer"
  key_links:
    - from: "packages/mcp_json_yaml_toml/services/data_operations.py"
      to: "packages/mcp_json_yaml_toml/yq_wrapper.py"
      via: "execute_yq import"
      pattern: "from mcp_json_yaml_toml.yq_wrapper import"
    - from: "packages/mcp_json_yaml_toml/services/data_operations.py"
      to: "packages/mcp_json_yaml_toml/services/pagination.py"
      via: "pagination function imports"
      pattern: "from mcp_json_yaml_toml.services.pagination import"
    - from: "packages/mcp_json_yaml_toml/server.py"
      to: "packages/mcp_json_yaml_toml/services/data_operations.py"
      via: "import and delegation"
      pattern: "from mcp_json_yaml_toml.services.data_operations import"
---

<objective>
Extract data operations business logic from server.py into services/data_operations.py.

Purpose: Move the ~500 lines of CRUD handler logic (dispatchers, data get/set/delete handlers,
query response builder, write validation) out of server.py into a dedicated service module. This
is the largest extraction in Phase 2 and must complete before the tool layer can be split out in
Plan 03, because tools will delegate to these service functions.

Output: services/data_operations.py containing all business logic functions. server.py imports
these functions and its tool decorators delegate to them.
</objective>

<execution_context>
@/home/ubuntulinuxqa2/.claude/get-shit-done/workflows/execute-plan.md
@/home/ubuntulinuxqa2/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-tool-layer-refactoring/02-RESEARCH.md
@.planning/phases/02-tool-layer-refactoring/02-01-SUMMARY.md
@packages/mcp_json_yaml_toml/server.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create services/data_operations.py with extracted business logic</name>
  <files>
    packages/mcp_json_yaml_toml/services/data_operations.py
  </files>
  <action>
Create `services/data_operations.py` by extracting these functions from server.py. Use `from __future__ import annotations`. The functions to extract (reference server.py line numbers from the research):

**Write validation pipeline (lines 84-170 approx):**

- `_validate_and_write_content(path, content, schema_path, input_format)` — validates content against schema then writes to file

**Data type guard (line ~172):**

- `is_schema(data) -> TypeGuard[dict[str, Any]]` — checks if data is a JSON Schema dict

**Data GET handlers (lines ~175-405 approx):**

- `_handle_data_get_schema(path, schema_manager)` — returns schema via SchemaResponse
- `_handle_data_get_structure(path, content, format_name)` — returns structure summary
- `_handle_data_get_value(path, content, format_name, expression, schema_manager)` — returns value with pagination

**Data SET handlers (lines ~408-560 approx):**

- `_set_toml_value_handler(file_path, expression, value)` — TOML-specific set
- `_optimize_yaml_if_needed(path, format_name)` — post-write YAML anchor optimization
- `_handle_data_set(path, expression, value, format_name, schema_path, content)` — SET orchestrator

**Data DELETE handlers (lines ~562-580 approx):**

- `_delete_toml_key_handler(file_path, expression)` — TOML-specific delete
- `_delete_yq_key_handler(file_path, expression, input_format)` — yq-based delete
- `_handle_data_delete(path, expression, format_name, schema_path, content)` — DELETE orchestrator

**Dispatch functions (lines ~643-778 approx):**

- `_dispatch_get_operation(path, content, format_name, expression, schema_manager)` — routes GET ops
- `_dispatch_set_operation(path, content, format_name, expression, value, schema_path)` — routes SET ops
- `_dispatch_delete_operation(path, content, format_name, expression, schema_path)` — routes DELETE ops

**Query response builder (lines ~781-900 approx):**

- `_build_query_response(path, expression, format_name, output_format, schema_manager)` — builds query result dict

**Required imports for data_operations.py** — gather from what these functions use:

- `pathlib.Path`
- `typing.Any, TypeGuard`
- `fastmcp.exceptions.ToolError`
- `mcp_json_yaml_toml.config` — `is_format_enabled`, `parse_enabled_formats`, `validate_format`
- `mcp_json_yaml_toml.formats.base` — `_detect_file_format`, `_parse_content_for_validation`, `_parse_set_value`
- `mcp_json_yaml_toml.yq_wrapper` — `FormatType`, `YQError`, `YQExecutionError`, `execute_yq`
- `mcp_json_yaml_toml.toml_utils` — `set_toml_value`, `delete_toml_key`
- `mcp_json_yaml_toml.yaml_optimizer` — `optimize_yaml_file`
- `mcp_json_yaml_toml.schemas` — `SchemaInfo`, `SchemaManager`
- `mcp_json_yaml_toml.services.pagination` — pagination functions as needed
- `mcp_json_yaml_toml.services.schema_validation` — `_validate_against_schema`
- `mcp_json_yaml_toml.models.responses` — `SchemaResponse` (used by \_handle_data_get_schema)

**Critical instructions:**

1. Move functions exactly as they appear in server.py. Do NOT refactor, rename, or change signatures.
2. `schema_manager` must be a PARAMETER to every function that uses it, not a global. Check if the function already takes it as a parameter. If not (e.g., `_build_query_response`), add `schema_manager: SchemaManager` as the last parameter.
3. Add `__all__` listing all public functions.
4. Do NOT modify server.py in this task. That happens in Task 2.

**Important:** Read the actual server.py line by line for each function being extracted. Do not rely on the line numbers above (they are approximate from research and may have shifted after Plan 01 changes). Find each function by name.
</action>
<verify>
uv run python -c "from mcp_json_yaml_toml.services.data_operations import \_dispatch_get_operation, \_dispatch_set_operation, \_dispatch_delete_operation, \_build_query_response, \_validate_and_write_content; print('Data operations OK')"
uv run ruff check packages/mcp_json_yaml_toml/services/data_operations.py
uv run ruff format --check packages/mcp_json_yaml_toml/services/data_operations.py
</verify>
<done>
All 16+ functions extracted to services/data_operations.py. Each function matches its original
signature (except schema_manager added as parameter where it was previously a global).
All imports resolved. Ruff clean.
</done>
</task>

<task type="auto">
  <name>Task 2: Update server.py to import from services/data_operations.py</name>
  <files>
    packages/mcp_json_yaml_toml/server.py
  </files>
  <action>
**Remove extracted function bodies from server.py.**

For every function moved to `services/data_operations.py`, remove its definition from server.py.

**Add import statement in server.py:**

```python
from mcp_json_yaml_toml.services.data_operations import (
    _build_query_response,
    _delete_toml_key_handler,
    _delete_yq_key_handler,
    _dispatch_delete_operation,
    _dispatch_get_operation,
    _dispatch_set_operation,
    _handle_data_delete,
    _handle_data_get_schema,
    _handle_data_get_structure,
    _handle_data_get_value,
    _handle_data_set,
    _optimize_yaml_if_needed,
    _set_toml_value_handler,
    _validate_and_write_content,
    is_schema,
)
```

**Clean up server.py imports:** After removing function bodies, some imports in server.py may become unused (e.g., `delete_toml_key`, `set_toml_value`, `optimize_yaml_file` if they're only used inside the moved functions). Verify each import is still used in the remaining server.py code before removing. Use `ruff check` to identify unused imports.

**Critical verification:** Run `uv run pytest -x` after the changes. All 395 tests must pass. The tool decorators in server.py still call the same functions — they're just imported now instead of defined locally.

**Important:** If `_build_query_response` previously accessed `schema_manager` as a global in server.py, the call site in the `data_query` tool decorator must now pass `schema_manager` as an argument. Check the function body for `schema_manager` references and update the call site accordingly.
</action>
<verify>
uv run pytest packages/mcp*json_yaml_toml/tests/ -x -q
uv run ruff check packages/mcp_json_yaml_toml/server.py
uv run mypy packages/mcp_json_yaml_toml/server.py packages/mcp_json_yaml_toml/services/data_operations.py --show-error-codes
wc -l packages/mcp_json_yaml_toml/server.py
</verify>
<done>
All \_handle*_, *dispatch*_, \_validate_and_write_content, is_schema, \_build_query_response
removed from server.py body and imported from services.data_operations.
server.py reduced by ~500 lines. All 395 tests pass. Ruff and mypy clean.
</done>
</task>

</tasks>

<verification>
- `uv run pytest packages/mcp_json_yaml_toml/tests/ -q` — all tests pass
- `uv run ruff check packages/mcp_json_yaml_toml/` — clean
- `wc -l packages/mcp_json_yaml_toml/server.py` — significantly reduced (expect ~900-1000 lines)
- `grep -c "def " packages/mcp_json_yaml_toml/services/data_operations.py` — 15+ function definitions
</verification>

<success_criteria>

- services/data_operations.py exists with all extracted business logic functions
- server.py no longer defines any _handle\_\_, *dispatch*_, is_schema, or \_validate_and_write_content functions
- server.py imports them from services.data_operations
- All 395 tests pass without modification
- server.py line count reduced by approximately 500 lines
  </success_criteria>

<output>
After completion, create `.planning/phases/02-tool-layer-refactoring/02-02-SUMMARY.md`
</output>
