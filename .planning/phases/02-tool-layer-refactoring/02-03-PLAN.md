---
phase: 02-tool-layer-refactoring
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - packages/mcp_json_yaml_toml/tools/__init__.py
  - packages/mcp_json_yaml_toml/tools/data.py
  - packages/mcp_json_yaml_toml/tools/query.py
  - packages/mcp_json_yaml_toml/tools/schema.py
  - packages/mcp_json_yaml_toml/tools/convert.py
  - packages/mcp_json_yaml_toml/tools/constraints.py
  - packages/mcp_json_yaml_toml/server.py
autonomous: true

must_haves:
  truths:
    - "Each tool has its own file in tools/ directory"
    - "server.py contains only FastMCP init, schema_manager init, tool imports/re-exports, and main()"
    - "server.py is under 100 lines"
    - "All test import paths continue to work (server.data_query, server.data, server.mcp, etc.)"
    - "Existing tool names unchanged — data, data_query, data_schema, data_convert, data_merge"
    - "All 395 existing tests pass without modification"
  artifacts:
    - path: "packages/mcp_json_yaml_toml/tools/__init__.py"
      provides: "Package marker for tools"
    - path: "packages/mcp_json_yaml_toml/tools/data.py"
      provides: "data tool decorator"
      contains: "@mcp.tool"
    - path: "packages/mcp_json_yaml_toml/tools/query.py"
      provides: "data_query tool decorator"
      contains: "@mcp.tool"
    - path: "packages/mcp_json_yaml_toml/tools/schema.py"
      provides: "data_schema tool decorator and schema action handlers"
      contains: "@mcp.tool"
    - path: "packages/mcp_json_yaml_toml/tools/convert.py"
      provides: "data_convert and data_merge tool decorators"
      contains: "@mcp.tool"
    - path: "packages/mcp_json_yaml_toml/tools/constraints.py"
      provides: "constraint tools, resources, and prompts"
      contains: "@mcp.tool"
    - path: "packages/mcp_json_yaml_toml/server.py"
      provides: "Thin registration shell under 100 lines"
      min_lines: 40
  key_links:
    - from: "packages/mcp_json_yaml_toml/tools/data.py"
      to: "packages/mcp_json_yaml_toml/server.py"
      via: "imports mcp object"
      pattern: "from mcp_json_yaml_toml.server import mcp"
    - from: "packages/mcp_json_yaml_toml/tools/data.py"
      to: "packages/mcp_json_yaml_toml/services/data_operations.py"
      via: "delegates to service layer"
      pattern: "from mcp_json_yaml_toml.services.data_operations import"
    - from: "packages/mcp_json_yaml_toml/server.py"
      to: "packages/mcp_json_yaml_toml/tools/data.py"
      via: "re-export for backward compat"
      pattern: "from mcp_json_yaml_toml.tools.data import data"
---

<objective>
Split tool decorators from server.py into individual tools/ module files.

Purpose: This is the core structural change of Phase 2 — moving all 7 @mcp.tool decorators,
2 @mcp.resource decorators, and 3 @mcp.prompt decorators out of server.py into dedicated files
under tools/. After this plan, server.py becomes a thin shell containing only FastMCP initialization,
schema_manager creation, tool module imports with re-exports, and main().

This is the HIGHEST RISK plan in Phase 2 due to circular import potential (tools import mcp from
server, server re-exports tools) and backward compatibility requirements (tests access tools via
server.data_query.fn pattern).

Output: 5 tool modules + transformed server.py under 100 lines.
</objective>

<execution_context>
@/home/ubuntulinuxqa2/.claude/get-shit-done/workflows/execute-plan.md
@/home/ubuntulinuxqa2/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-tool-layer-refactoring/02-RESEARCH.md
@.planning/phases/02-tool-layer-refactoring/02-01-SUMMARY.md
@.planning/phases/02-tool-layer-refactoring/02-02-SUMMARY.md
@packages/mcp_json_yaml_toml/server.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tools/ package with all tool modules</name>
  <files>
    packages/mcp_json_yaml_toml/tools/__init__.py
    packages/mcp_json_yaml_toml/tools/data.py
    packages/mcp_json_yaml_toml/tools/query.py
    packages/mcp_json_yaml_toml/tools/schema.py
    packages/mcp_json_yaml_toml/tools/convert.py
    packages/mcp_json_yaml_toml/tools/constraints.py
  </files>
  <action>
**Create `tools/__init__.py`:**
Empty package marker with a module docstring.

**For each tool module below, follow this pattern:**

1. Import `mcp` (and `schema_manager` where needed) from `mcp_json_yaml_toml.server`
2. Import service functions from `mcp_json_yaml_toml.services.data_operations` (or other services)
3. Move the `@mcp.tool()` / `@mcp.resource()` / `@mcp.prompt()` decorated function from server.py
4. Keep the function body exactly as it exists — these are thin decorators that delegate to services

**tools/data.py** — the `data` tool:

- Import `mcp`, `schema_manager` from server
- Import dispatch functions from services.data_operations
- Import config functions, format utilities, ToolError
- Move the `data()` tool function (the @mcp.tool decorator + body). The body calls `_dispatch_get_operation`, `_dispatch_set_operation`, `_dispatch_delete_operation`.
- The data tool currently has NO annotations — keep it that way (annotations added in Plan 04).

**tools/query.py** — the `data_query` tool:

- Import `mcp`, `schema_manager` from server
- Import `_build_query_response` from services.data_operations
- Import config functions, ToolError
- Move the `data_query()` tool function. Body calls `_build_query_response`.
- Keep existing annotation: `annotations={"readOnlyHint": True}`

**tools/schema.py** — the `data_schema` tool + all schema handlers:

- Import `mcp`, `schema_manager` from server
- Import `_validate_against_schema` from services.schema_validation
- Move the `data_schema()` tool function AND the 7 `_handle_schema_*` functions that are still in server.py. These handlers (`_handle_schema_validate`, `_handle_schema_scan`, `_handle_schema_add_dir`, `_handle_schema_add_catalog`, `_handle_schema_associate`, `_handle_schema_disassociate`, `_handle_schema_list`) are NOT in services/data_operations.py — they're still in server.py after Plan 02.
- Imports needed: `httpx`, `orjson`, `SchemaInfo`, `SchemaManager`, `SchemaError`, `_parse_content_for_validation`, config functions, etc.

**tools/convert.py** — `data_convert` and `data_merge` tools:

- Import `mcp` from server
- Move both `data_convert()` and `data_merge()` tool functions.
- These tools contain inline business logic (format conversion, merge execution). Move the entire body as-is. They use `execute_yq`, `_detect_file_format`, config functions, pagination functions.
- Keep existing annotations: `annotations={"readOnlyHint": True}` on both.

**tools/constraints.py** — constraint tools, resources, and prompts:

- Import `mcp` from server
- Move: `constraint_validate()` tool, `constraint_list()` tool, `list_all_constraints()` resource, `get_constraint_definition()` resource, `explain_config()` prompt, `suggest_improvements()` prompt, `convert_to_schema()` prompt
- Keep existing annotations on constraint tools.
- These functions use `ConstraintRegistry`, `validate_tool_input`, `get_constraint_hint` from lmql_constraints.

**Critical: Do NOT modify server.py in this task.** Only create the new tool files.

**Circular import prevention:** The tool modules import `mcp` from `server`. The server will import tool symbols from tool modules (in Task 2). This circular import works ONLY because `mcp = FastMCP(...)` is defined at the top of server.py BEFORE the tool imports. Python's import machinery finds `mcp` already defined in the partially-loaded `server` module when `tools/*.py` triggers its import.
</action>
<verify>
uv run python -c "
from mcp_json_yaml_toml.tools.data import data
from mcp_json_yaml_toml.tools.query import data_query
from mcp_json_yaml_toml.tools.schema import data_schema
from mcp_json_yaml_toml.tools.convert import data_convert, data_merge
from mcp_json_yaml_toml.tools.constraints import constraint_validate, constraint_list
print('All tool modules importable')
"
uv run ruff check packages/mcp_json_yaml_toml/tools/
uv run ruff format --check packages/mcp_json_yaml_toml/tools/
</verify>
<done>
All 5 tool modules created in tools/ directory. Each imports mcp from server and delegates
to service layer. All tool, resource, and prompt decorators moved. Ruff clean.
</done>
</task>

<task type="auto">
  <name>Task 2: Transform server.py into thin registration shell</name>
  <files>
    packages/mcp_json_yaml_toml/server.py
  </files>
  <action>
**Rewrite server.py to be a thin registration shell.**

The final server.py should contain ONLY:

1. Module docstring
2. `from __future__ import annotations`
3. Essential imports (FastMCP, SchemaManager)
4. `mcp = FastMCP("mcp-json-yaml-toml", mask_error_details=False)`
5. `schema_manager = SchemaManager()`
6. Tool module imports that trigger registration AND re-export symbols for backward compat
7. Pagination re-exports (already exist from Phase 1)
8. `main()` function
9. `if __name__ == "__main__":` guard

**Re-exports required for test backward compatibility** (verified from research section 7):

```python
# Tool re-exports — tests access these via server.data_query.fn(), etc.
from mcp_json_yaml_toml.tools.data import data  # noqa: F401
from mcp_json_yaml_toml.tools.query import data_query  # noqa: F401
from mcp_json_yaml_toml.tools.schema import data_schema  # noqa: F401
from mcp_json_yaml_toml.tools.convert import data_convert, data_merge  # noqa: F401
from mcp_json_yaml_toml.tools.constraints import (  # noqa: F401
    constraint_list,
    constraint_validate,
    convert_to_schema,
    explain_config,
    get_constraint_definition,
    list_all_constraints,
    suggest_improvements,
)

# Model re-exports
from mcp_json_yaml_toml.models.responses import SchemaResponse  # noqa: F401

# Pagination re-exports (Phase 1 backward compat — already exist)
from mcp_json_yaml_toml.services.pagination import (  # noqa: F401
    ADVISORY_PAGE_THRESHOLD,
    MAX_PRIMITIVE_DISPLAY_LENGTH,
    PAGE_SIZE_CHARS,
    _decode_cursor,
    _encode_cursor,
    _get_pagination_hint,
    _paginate_result,
    _summarize_structure,
)
```

**IMPORTANT ordering for circular import resolution:**

1. `mcp = FastMCP(...)` and `schema_manager = SchemaManager()` MUST be defined BEFORE any tool imports
2. The tool imports MUST come AFTER mcp and schema_manager definitions
3. Use `# noqa: E402` on the tool imports since they're not at the top of the file

**Remove everything else from server.py:** All function definitions, all business logic, all handler code. Everything should have been moved to services/ or tools/ in Plans 01-03.

**Target: server.py under 100 lines.** With the docstring, imports, mcp init, schema_manager init, re-exports, main(), and guard, this should be approximately 60-80 lines.

**Critical verification steps (run in order):**

1. `uv run python -c "from mcp_json_yaml_toml import server"` — no ImportError
2. `uv run python -c "from mcp_json_yaml_toml import server; print(hasattr(server, 'data_query'))"` — True
3. `uv run python -c "from mcp_json_yaml_toml import server; print(hasattr(server, 'schema_manager'))"` — True
4. `uv run python -c "from mcp_json_yaml_toml import server; print(hasattr(server, 'mcp'))"` — True
5. `uv run python -c "from mcp_json_yaml_toml.server import data_query"` — works
6. `uv run python -c "from mcp_json_yaml_toml.server import _decode_cursor"` — works (pagination re-export)
7. `uv run pytest packages/mcp_json_yaml_toml/tests/ -x -q` — all 395 tests pass
   </action>
   <verify>
   wc -l packages/mcp_json_yaml_toml/server.py
   uv run python -c "from mcp_json_yaml_toml import server; attrs = ['data', 'data_query', 'data_schema', 'data_convert', 'data_merge', 'constraint_validate', 'constraint_list', 'explain_config', 'suggest_improvements', 'convert_to_schema', 'list_all_constraints', 'get_constraint_definition', 'mcp', 'schema_manager', 'SchemaResponse', '_decode_cursor', '_encode_cursor', '_paginate_result']; missing = [a for a in attrs if not hasattr(server, a)]; print(f'Missing: {missing}' if missing else 'All attributes present')"
   uv run pytest packages/mcp_json_yaml_toml/tests/ -x -q
   uv run ruff check packages/mcp_json_yaml_toml/server.py
   uv run mypy packages/ --show-error-codes
   </verify>
   <done>
   server.py is under 100 lines. Contains only FastMCP init, schema_manager init, tool
   re-exports, pagination re-exports, SchemaResponse re-export, and main().
   All 18 backward-compat attributes accessible on server module.
   All 395 tests pass. Ruff and mypy clean.
   </done>
   </task>

</tasks>

<verification>
- `wc -l packages/mcp_json_yaml_toml/server.py` — under 100 lines
- `ls packages/mcp_json_yaml_toml/tools/` — __init__.py, data.py, query.py, schema.py, convert.py, constraints.py
- `uv run pytest packages/mcp_json_yaml_toml/tests/ -q` — all tests pass
- `uv run ruff check packages/mcp_json_yaml_toml/` — clean
- `uv run mypy packages/ --show-error-codes` — no new errors
- All server.* attributes accessible (data, data_query, data_schema, data_convert, data_merge, constraint_validate, constraint_list, explain_config, suggest_improvements, convert_to_schema, list_all_constraints, get_constraint_definition, mcp, schema_manager, SchemaResponse, _decode_cursor, _encode_cursor, _paginate_result)
</verification>

<success_criteria>

- server.py is under 100 lines (thin registration shell)
- 5 tool modules exist in tools/ directory
- All tool names unchanged
- All test backward compatibility maintained
- All 395 tests pass without modification
  </success_criteria>

<output>
After completion, create `.planning/phases/02-tool-layer-refactoring/02-03-SUMMARY.md`
</output>
