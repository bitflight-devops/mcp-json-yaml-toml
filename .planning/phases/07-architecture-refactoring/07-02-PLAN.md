---
phase: 07-architecture-refactoring
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - packages/mcp_json_yaml_toml/schemas/__init__.py
  - packages/mcp_json_yaml_toml/schemas/models.py
  - packages/mcp_json_yaml_toml/schemas/loading.py
  - packages/mcp_json_yaml_toml/schemas/ide_cache.py
  - packages/mcp_json_yaml_toml/schemas/scanning.py
  - packages/mcp_json_yaml_toml/schemas/manager.py
  - packages/mcp_json_yaml_toml/schemas.py
  - packages/mcp_json_yaml_toml/server.py
  - packages/mcp_json_yaml_toml/tools/schema.py
  - packages/mcp_json_yaml_toml/tools/data.py
autonomous: true

must_haves:
  truths:
    - "schemas.py is replaced by a schemas/ package with focused sub-modules for loading, IDE cache, and scanning"
    - "server.py __all__ contains only public API symbols (tools, core objects, main)"
    - "tools/schema.py handler functions accept schema_manager as a parameter instead of importing the module singleton"
  artifacts:
    - path: "packages/mcp_json_yaml_toml/schemas/__init__.py"
      provides: "Re-exports all public symbols from sub-modules for backward compatibility"
      exports:
        [
          "SchemaManager",
          "SchemaInfo",
          "SchemaConfig",
          "SchemaCatalog",
          "SchemaEntry",
        ]
    - path: "packages/mcp_json_yaml_toml/schemas/models.py"
      provides: "All dataclass definitions (SchemaInfo, SchemaEntry, SchemaCatalog, FileAssociation, SchemaConfig, DefaultSchemaStores, ExtensionSchemaMapping, IDESchemaIndex)"
      contains: "SchemaInfo"
    - path: "packages/mcp_json_yaml_toml/schemas/loading.py"
      provides: "Schema extraction functions (_extract_from_json, _extract_from_yaml, _extract_from_toml, _extract_schema_url_from_content, _strip_json_comments)"
      contains: "_extract_schema_url_from_content"
    - path: "packages/mcp_json_yaml_toml/schemas/ide_cache.py"
      provides: "IDE extension schema discovery (IDESchemaProvider, _parse_extension_schemas, _build_ide_schema_index, related helpers)"
      contains: "IDESchemaProvider"
    - path: "packages/mcp_json_yaml_toml/schemas/scanning.py"
      provides: "Schema directory scanning helpers (_get_ide_schema_locations, _expand_ide_patterns, _load_default_ide_patterns)"
      contains: "_get_ide_schema_locations"
    - path: "packages/mcp_json_yaml_toml/schemas/manager.py"
      provides: "SchemaManager class with config, catalog, fetch, and association methods"
      contains: "class SchemaManager"
  key_links:
    - from: "packages/mcp_json_yaml_toml/schemas/__init__.py"
      to: "schemas/models.py, schemas/loading.py, schemas/ide_cache.py, schemas/scanning.py, schemas/manager.py"
      via: "re-export imports"
      pattern: "from mcp_json_yaml_toml\\.schemas\\.(models|loading|ide_cache|scanning|manager) import"
    - from: "packages/mcp_json_yaml_toml/tools/schema.py"
      to: "packages/mcp_json_yaml_toml/schemas/manager.py"
      via: "schema_manager parameter on handler functions"
      pattern: "schema_manager: SchemaManager"
    - from: "packages/mcp_json_yaml_toml/server.py"
      to: "packages/mcp_json_yaml_toml/schemas/__init__.py"
      via: "import SchemaManager"
      pattern: "from mcp_json_yaml_toml\\.schemas import SchemaManager"
---

<objective>
Split schemas.py into a focused package, clean server.py exports, and parameterize schema_manager in tool handlers.

Purpose: Eliminate the second god module (1200 lines mixing data models, content extraction, IDE integration, directory scanning, and schema management), remove private symbols from server.py's public API, and decouple tool handlers from the module-level singleton.

Output: A `schemas/` package with 5 focused modules, a cleaned server.py **all**, and schema tool handlers that accept schema_manager as a parameter.
</objective>

<execution_context>
@/home/ubuntulinuxqa2/.claude/get-shit-done/workflows/execute-plan.md
@/home/ubuntulinuxqa2/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-architecture-refactoring/07-01-SUMMARY.md
@packages/mcp_json_yaml_toml/schemas.py
@packages/mcp_json_yaml_toml/server.py
@packages/mcp_json_yaml_toml/tools/schema.py
@packages/mcp_json_yaml_toml/tools/data.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Split schemas.py into focused sub-modules (ARCH-07)</name>
  <files>
    packages/mcp_json_yaml_toml/schemas/models.py
    packages/mcp_json_yaml_toml/schemas/loading.py
    packages/mcp_json_yaml_toml/schemas/ide_cache.py
    packages/mcp_json_yaml_toml/schemas/scanning.py
    packages/mcp_json_yaml_toml/schemas/manager.py
    packages/mcp_json_yaml_toml/schemas/__init__.py
    packages/mcp_json_yaml_toml/schemas.py
  </files>
  <action>
Convert `schemas.py` (1200 lines) from a monolithic module to a `schemas/` package with focused sub-modules.

**Step 1: Create `schemas/` directory** as a Python package.

**Step 2: Create `schemas/models.py`** containing all dataclass definitions:

- `SchemaInfo` (lines 37-43)
- `SchemaEntry` (lines 47-53)
- `SchemaCatalog` (lines 56-63)
- `FileAssociation` (lines 66-72)
- `SchemaConfig` (lines 75-82)
- `DefaultSchemaStores` (lines 86-89)
- `ExtensionSchemaMapping` (lines 93-98)
- `IDESchemaIndex` (lines 102-107)

These are pure data structures with no business logic. Move them as-is.

**Step 3: Create `schemas/loading.py`** containing content extraction functions:

- `_COMMENT_RE` regex constant
- `_strip_json_comments()`
- `_extract_from_json()`
- `_extract_from_yaml()`
- `_extract_from_toml()`
- `_extract_schema_url_from_content()`
- `_match_glob_pattern()`

These functions extract `$schema` URLs from file content. They depend only on standard libraries and parsing libraries (orjson, ruamel.yaml, tomlkit).

**Step 4: Create `schemas/ide_cache.py`** containing IDE extension schema discovery:

- `IDESchemaProvider` class (lines 532-631)
- `_get_ide_schema_index_path()` (lines 373-385)
- `_extract_validation_mapping()` (lines 388-419)
- `_parse_extension_schemas()` (lines 422-481)
- `_find_potential_extension_dirs()` (lines 484-500)
- `_build_ide_schema_index()` (lines 503-529)

These handle VS Code extension schema discovery and caching.

**Step 5: Create `schemas/scanning.py`** containing directory scanning helpers:

- `_load_default_ide_patterns()` (lines 271-291)
- `_expand_ide_patterns()` (lines 294-323)
- `_get_ide_schema_locations()` (lines 326-370)
- `SCHEMA_STORE_CATALOG_URL` constant
- `CACHE_EXPIRY_SECONDS` constant

These find IDE schema directories from config, environment, and known patterns.

**Step 6: Create `schemas/manager.py`** containing the `SchemaManager` class:

- Full `SchemaManager` class (lines 633-1201)

This is the main facade class. It imports from all other sub-modules:

- Models from `schemas.models`
- Loading functions from `schemas.loading`
- IDESchemaProvider from `schemas.ide_cache`
- Scanning functions from `schemas.scanning`

**Step 7: Create `schemas/__init__.py`** that re-exports all public symbols:

```python
from mcp_json_yaml_toml.schemas.models import (
    SchemaInfo, SchemaEntry, SchemaCatalog, FileAssociation,
    SchemaConfig, DefaultSchemaStores, ExtensionSchemaMapping,
    IDESchemaIndex,
)
from mcp_json_yaml_toml.schemas.loading import (
    _extract_schema_url_from_content, _match_glob_pattern,
    _strip_json_comments, _extract_from_json, _extract_from_yaml,
    _extract_from_toml,
)
from mcp_json_yaml_toml.schemas.ide_cache import (
    IDESchemaProvider, _parse_extension_schemas, _build_ide_schema_index,
    _find_potential_extension_dirs, _get_ide_schema_index_path,
    _extract_validation_mapping,
)
from mcp_json_yaml_toml.schemas.scanning import (
    _load_default_ide_patterns, _expand_ide_patterns,
    _get_ide_schema_locations, SCHEMA_STORE_CATALOG_URL,
    CACHE_EXPIRY_SECONDS,
)
from mcp_json_yaml_toml.schemas.manager import SchemaManager
```

All imports should have `# noqa: F401` where needed.

**Step 8: Handle the old `schemas.py` file.**
The old `schemas.py` file must be REMOVED (renamed/deleted) because Python cannot have both `schemas.py` and `schemas/` in the same directory -- the package takes precedence. Since `schemas/__init__.py` re-exports everything, all existing import paths (`from mcp_json_yaml_toml.schemas import SchemaManager`) continue to work.

Delete `schemas.py` after verifying the package **init**.py provides all the same exports.

**Critical implementation notes:**

- `schemas/manager.py` imports `_match_glob_pattern` from `schemas.loading` (used in `_lookup_catalog_schema`)
- `schemas/manager.py` imports `_extract_schema_url_from_content` from `schemas.loading`
- `schemas/manager.py` imports `IDESchemaProvider` from `schemas.ide_cache`
- `schemas/manager.py` imports `_get_ide_schema_locations` from `schemas.scanning`
- `schemas/ide_cache.py` imports `_expand_ide_patterns` from `schemas.scanning`
- `schemas/ide_cache.py` imports `ExtensionSchemaMapping`, `IDESchemaIndex`, `DefaultSchemaStores` from `schemas.models`
- All function signatures, docstrings, and behavior must be preserved exactly
  </action>
  <verify>

```bash
uv run pytest packages/mcp_json_yaml_toml/tests/test_schemas.py -x -q
uv run pytest packages/mcp_json_yaml_toml/tests/test_schema_detection.py -x -q
uv run pytest packages/mcp_json_yaml_toml/tests/ -x -q
uv run prek run --files packages/mcp_json_yaml_toml/schemas/__init__.py packages/mcp_json_yaml_toml/schemas/models.py packages/mcp_json_yaml_toml/schemas/loading.py packages/mcp_json_yaml_toml/schemas/ide_cache.py packages/mcp_json_yaml_toml/schemas/scanning.py packages/mcp_json_yaml_toml/schemas/manager.py
```

  </verify>
  <done>
schemas.py replaced by schemas/ package with 5 focused modules (models, loading, ide_cache, scanning, manager). All existing imports (`from mcp_json_yaml_toml.schemas import X`) continue to work via __init__.py re-exports. All schema tests pass. All linters pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Clean server.py __all__ and parameterize schema_manager in tool handlers (ARCH-09 + ARCH-10)</name>
  <files>
    packages/mcp_json_yaml_toml/server.py
    packages/mcp_json_yaml_toml/tools/schema.py
    packages/mcp_json_yaml_toml/tools/data.py
  </files>
  <action>
**Part A: Clean server.py __all__ (ARCH-09)**

The current `server.py` **all** contains 30+ symbols, many of which are private implementation details re-exported for backward compatibility (e.g., `_build_query_response`, `_decode_cursor`, `_dispatch_get_operation`). These private symbols should be imported by tests from their originating modules, not from server.

Update `server.py`:

1. **Remove private re-exports from**all\*\*\*\*. The following symbols should be REMOVED from `__all__` (and their import statements removed from server.py):
   - `_build_query_response` (import from `services.data_operations` or `services.query_operations`)
   - `_dispatch_delete_operation` (import from `services.data_operations` or `services.mutation_operations`)
   - `_dispatch_get_operation` (import from `services.data_operations` or `services.get_operations`)
   - `_dispatch_set_operation` (import from `services.data_operations` or `services.mutation_operations`)
   - `_validate_and_write_content` (import from `services.data_operations` or `services.mutation_operations`)
   - `_decode_cursor` (import from `services.pagination`)
   - `_encode_cursor` (import from `services.pagination`)
   - `_get_pagination_hint` (import from `services.pagination`)
   - `_paginate_result` (import from `services.pagination`)
   - `_summarize_structure` (import from `services.pagination`)
   - `is_schema` (import from `services.data_operations` or `services.get_operations`)
   - `ADVISORY_PAGE_THRESHOLD` (import from `services.pagination`)
   - `MAX_PRIMITIVE_DISPLAY_LENGTH` (import from `services.pagination`)
   - `PAGE_SIZE_CHARS` (import from `services.pagination`)

2. **Keep only public API symbols in**all\*\*\*\*:

   ```python
   __all__ = [
       # Models
       "SchemaResponse",
       # Tools
       "constraint_list",
       "constraint_validate",
       "data",
       "data_convert",
       "data_diff",
       "data_merge",
       "data_query",
       "data_schema",
       # Prompts
       "explain_config",
       "convert_to_schema",
       # Resources
       "list_all_constraints",
       "get_constraint_definition",
       "suggest_improvements",
       # Core objects
       "mcp",
       "schema_manager",
       "main",
   ]
   ```

3. **Remove the import statements** for all symbols removed from **all**. The `from mcp_json_yaml_toml.services.data_operations import ...` and `from mcp_json_yaml_toml.services.pagination import ...` blocks should be deleted entirely from server.py.

4. **Update any test files** that import private symbols from server.py to import from the originating module instead. Check:
   - `tests/test_pagination.py` line 11: `from mcp_json_yaml_toml.server import _decode_cursor, _encode_cursor, _paginate_result` -> change to `from mcp_json_yaml_toml.services.pagination import _decode_cursor, _encode_cursor, _paginate_result`
   - Any other test importing private symbols from server -- grep for `from mcp_json_yaml_toml.server import _`

**Part B: Parameterize schema_manager in tools/schema.py handlers (ARCH-10)**

Currently `tools/schema.py` imports `schema_manager` as a module singleton:

```python
from mcp_json_yaml_toml.server import mcp, schema_manager
```

And all 7 handler functions (`_handle_schema_validate`, `_handle_schema_scan`, `_handle_schema_add_dir`, `_handle_schema_add_catalog`, `_handle_schema_associate`, `_handle_schema_disassociate`, `_handle_schema_list`) access `schema_manager` as a module-global.

Refactor to accept `schema_manager` as a parameter:

1. Add `schema_manager: SchemaManager` parameter to each handler function. Use TYPE_CHECKING import for the type annotation.

2. Update the `data_schema()` tool function to pass `schema_manager` to each handler call in the `handlers` dict.

3. Remove `schema_manager` from the `from mcp_json_yaml_toml.server import mcp, schema_manager` line. Import only `mcp` from server. Import `schema_manager` only where needed (in the tool function itself, which gets it from server).

Actually, the tool function still needs access to schema_manager to pass it. The cleanest approach:

- Keep `from mcp_json_yaml_toml.server import mcp, schema_manager` in tools/schema.py
- Add `schema_manager` parameter to all handler functions
- In the tool function, pass `schema_manager` to each handler
- This means handlers are testable independently (can pass mock schema_manager) while the tool function wires them to the singleton

4. Similarly verify `tools/data.py` -- it already passes `schema_manager` to dispatch functions. No changes needed there.
   </action>
   <verify>

```bash
uv run pytest packages/mcp_json_yaml_toml/tests/ -x -q
uv run prek run --files packages/mcp_json_yaml_toml/server.py packages/mcp_json_yaml_toml/tools/schema.py packages/mcp_json_yaml_toml/tools/data.py
# Verify __all__ is clean
uv run python -c "from mcp_json_yaml_toml import server; print([s for s in server.__all__ if s.startswith('_')])"
# Should print empty list []
```

  </verify>
  <done>
server.py __all__ contains only public API symbols (tools, models, core objects, main). No private symbols (_-prefixed or constants) re-exported. Tests import private symbols from originating modules. tools/schema.py handler functions accept schema_manager as parameter. All tests pass. All linters pass.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **ARCH-07 verification**: `ls packages/mcp_json_yaml_toml/schemas/` shows `__init__.py`, `models.py`, `loading.py`, `ide_cache.py`, `scanning.py`, `manager.py`. Old `schemas.py` deleted.
2. **ARCH-09 verification**: `uv run python -c "from mcp_json_yaml_toml import server; print([s for s in server.__all__ if s.startswith('_')])"` returns `[]`.
3. **ARCH-10 verification**: `grep "def _handle_schema_" packages/mcp_json_yaml_toml/tools/schema.py` shows all handlers have `schema_manager` parameter in signature.
4. **Full test suite**: `uv run pytest packages/mcp_json_yaml_toml/tests/ -x -q` passes.
5. **Full lint**: `uv run prek run --files <all modified files>` passes.
   </verification>

<success_criteria>

- schemas/ package exists with 5 focused sub-modules
- Old schemas.py file deleted
- All existing imports from `mcp_json_yaml_toml.schemas` continue to work
- server.py **all** has zero private (\_-prefixed) symbols
- tools/schema.py handlers accept schema_manager as parameter
- All 60+ existing tests pass (with test import path updates where needed)
- All quality gates pass
  </success_criteria>

<output>
After completion, create `.planning/phases/07-architecture-refactoring/07-02-SUMMARY.md`
</output>
