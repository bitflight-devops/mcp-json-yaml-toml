---
phase: 03-fastmcp-3x-migration
plan: 02
subsystem: infra
tags: [fastmcp, timeout, json-schema, draft-2020-12, outputSchema]

# Dependency graph
requires:
  - phase: 03-fastmcp-3x-migration
    plan: 01
    provides: "FastMCP 3.x runtime (3.0.0rc2) with automatic threadpool dispatch"
  - phase: 02-tool-layer-refactoring
    provides: "Pydantic response models for automatic outputSchema generation"
provides:
  - "Tool timeout protection on all 7 MCP tools (FMCP-03)"
  - "Draft 2020-12 as default JSON Schema validator (SAFE-02)"
  - "outputSchema auto-generation verified for all tools"
affects: [phase-4]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "FastMCP 3.x timeout parameter on @mcp.tool() decorator"
    - "Draft 2020-12 as default JSON Schema validator with Draft 7 fallback"

key-files:
  created: []
  modified:
    - packages/mcp_json_yaml_toml/tools/data.py
    - packages/mcp_json_yaml_toml/tools/query.py
    - packages/mcp_json_yaml_toml/tools/schema.py
    - packages/mcp_json_yaml_toml/tools/convert.py
    - packages/mcp_json_yaml_toml/tools/constraints.py
    - packages/mcp_json_yaml_toml/services/schema_validation.py

key-decisions:
  - "60s timeout for file-processing tools (data, data_query, data_schema, data_convert, data_merge)"
  - "10s timeout for in-memory tools (constraint_validate, constraint_list)"
  - "Inverted schema default: Draft 2020-12 default, Draft 7 only for explicit $schema with draft-07"
  - "outputSchema auto-generated by FastMCP 3.x for all return types including dict[str, Any]"

patterns-established:
  - "FastMCP 3.x @mcp.tool(timeout=N, annotations={...}): timeout before annotations"
  - "output_schema (Python) maps to outputSchema (MCP protocol) automatically"

# Metrics
duration: 4min
completed: 2026-02-15
---

# Phase 3 Plan 02: Tool Timeouts, Schema Default Upgrade, and outputSchema Verification Summary

**60s/10s timeout protection on all 7 tools, Draft 2020-12 as default JSON Schema validator, and outputSchema auto-generation confirmed for all Pydantic and dict return types**

## Performance

- **Duration:** 4 min
- **Started:** 2026-02-15T05:45:39Z
- **Completed:** 2026-02-15T05:50:34Z
- **Tasks:** 2
- **Files modified:** 6

## Accomplishments

- Added timeout parameters to all 7 MCP tool decorators (FMCP-03 complete)
- Upgraded JSON Schema default validator from Draft 7 to Draft 2020-12 (SAFE-02 complete)
- Verified outputSchema auto-generation at both FastMCP internal and MCP protocol levels for all 7 tools
- All 393 tests pass with 79.16% coverage after changes

## Task Commits

Each task was committed atomically:

1. **Task 1: Add timeout parameters to all tool decorators** - `423e9f7` (feat)
2. **Task 2: Upgrade JSON Schema default validator to Draft 2020-12 and verify outputSchema** - `5d63d92` (feat)

## Files Created/Modified

- `packages/mcp_json_yaml_toml/tools/data.py` - Added timeout=60.0 to data tool
- `packages/mcp_json_yaml_toml/tools/query.py` - Added timeout=60.0 to data_query tool
- `packages/mcp_json_yaml_toml/tools/schema.py` - Added timeout=60.0 to data_schema tool
- `packages/mcp_json_yaml_toml/tools/convert.py` - Added timeout=60.0 to data_convert and data_merge tools
- `packages/mcp_json_yaml_toml/tools/constraints.py` - Added timeout=10.0 to constraint_validate and constraint_list tools
- `packages/mcp_json_yaml_toml/services/schema_validation.py` - Inverted validator default: Draft 2020-12 default, Draft 7 for explicit $schema

## Decisions Made

- **60s for file-processing tools:** data, data_query, data_schema, data_convert, data_merge all involve subprocess execution (yq) and/or file I/O -- 60s accommodates large files and slow networks (schema fetch)
- **10s for in-memory tools:** constraint_validate and constraint_list are pure in-memory regex operations -- 10s is generous
- **Inverted schema default logic:** Instead of matching "draft/2020-12" to select Draft 2020-12, now matches "draft-07" or "draft/7" to select Draft 7. Everything else (including no `$schema` field) defaults to Draft 2020-12
- **outputSchema for dict[str, Any]:** FastMCP 3.x generates `{"additionalProperties": true, "type": "object"}` for dict returns -- basic but functional; Pydantic models get rich schemas with field descriptions

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Phase 3 complete: all FMCP-01, FMCP-02, FMCP-03, and SAFE-02 requirements satisfied
- Ready for Phase 4: final hardening, documentation, and release preparation
- All 393 tests passing on FastMCP 3.0.0rc2 with 79.16% coverage

---

_Phase: 03-fastmcp-3x-migration_
_Completed: 2026-02-15_

## Self-Check: PASSED

- All 6 claimed modified files exist
- Commit 423e9f7 (Task 1) verified
- Commit 5d63d92 (Task 2) verified
- 393 tests pass on FastMCP 3.0.0rc2 with 79.16% coverage
